<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>PDF Editor ‚Äì Tools</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";</script>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

  <style>
    :root{
      --bg:#f7f8fc; --panel:#fff; --text:#1b1f3a; --muted:#6a7186;
      --brand:#0d6efd; --border:#e6e8f0; --accent:#12b886; --danger:#e03131;
    }
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .app{display:grid; grid-template-rows:auto 1fr; height:100%}
    header{background:var(--panel); border-bottom:1px solid var(--border); position:sticky; top:0; z-index:10}
    .toolbar{display:flex; flex-wrap:wrap; gap:.5rem; align-items:center; padding:.75rem 1rem; max-width:100%; margin:0 auto}
    .toolbar .group{display:flex; flex-wrap:wrap; gap:.5rem; align-items:center; background:#fff; border:1px solid var(--border); border-radius:12px; padding:.4rem .5rem}
    .btn{appearance:none; border:1px solid var(--border); background:#fff; border-radius:10px; padding:.45rem .7rem; cursor:pointer; transition:.15s; font-weight:600}
    .btn:hover{border-color:#cdd2e1; transform:translateY(-1px)}
    .btn.primary{background:var(--brand); color:#fff; border-color:var(--brand)}
    .btn.green{background:var(--accent); color:#fff; border-color:var(--accent)}
    .btn.red{background:var(--danger); color:#fff; border-color:var(--danger)}
    .btn[disabled]{opacity:.55; cursor:not-allowed; transform:none}
    .input,.select{border:1px solid var(--border); border-radius:10px; padding:.35rem .5rem; background:#fff; min-height:34px}

    .main{display:grid; grid-template-columns:minmax(220px, 300px) 1fr; gap:1rem; height:100%; width:100%; margin:0 auto; padding:1rem; box-sizing:border-box; max-width:1600px}
    .sidebar{background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:.75rem; overflow:auto}
    .side-head{display:flex; align-items:center; justify-content:space-between; margin-bottom:.5rem}
    .thumbs{list-style:none; margin:0; padding:0; display:grid; grid-template-columns:1fr; gap:.6rem}
    .thumb{border:1px solid var(--border); border-radius:10px; background:#fff; padding:.5rem; display:grid; grid-template-columns:1fr auto; gap:.5rem; align-items:center}
    .thumb .canvas-wrap{grid-column:1 / -1; aspect-ratio:3/4; overflow:hidden; display:flex; align-items:center; justify-content:center; background:#f3f5fb; border:1px dashed #e1e4ef; border-radius:8px}
    .thumb img{max-width:100%; height:auto; display:block}
    .thumb .meta{display:flex; align-items:center; justify-content:space-between; gap:.5rem}
    .thumb .title{font-weight:700}
    .thumb .actions{display:flex; gap:.35rem}
    .thumb .drag{cursor:grab; opacity:.75}
    .thumb.active{outline:2px solid var(--brand)}

    .editor{background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:1rem; display:grid; grid-template-rows:auto 1fr; min-height:0}
    .editor-head{display:flex; align-items:center; justify-content:space-between; gap:.5rem; flex-wrap:wrap; margin-bottom:.5rem}
    .stage{position:relative; overflow:auto; background:repeating-linear-gradient(45deg,#fafbff,#fafbff 10px,#f6f7fd 10px,#f6f7fd 20px); border-radius:10px; border:1px dashed #e1e4ef; min-height:300px}
    #fabricStage{position:absolute; left:0; top:0; /* NO CSS TRANSFORM for accurate hit test */ }

    .hint{color:var(--muted); font-size:12px}
    .split-bar{display:flex; align-items:center; justify-content:space-between; margin:.3rem 0 .6rem}

    @media (max-width:1100px){ .main{grid-template-columns:1fr} .sidebar{order:2} .editor{order:1} }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="toolbar">
      <div class="group">
        <button class="btn primary" id="openPdfBtn">Buka PDF‚Ä¶</button>
        <button class="btn" id="addMorePdfBtn" title="Merge">Tambah PDF‚Ä¶</button>
        <input type="file" id="pdfInput" accept="application/pdf" multiple hidden />
        <input type="file" id="pdfInputMerge" accept="application/pdf" multiple hidden />
      </div>

      <div class="group">
        <button class="btn" id="addTextBtn">‚ûï Teks</button>
        <button class="btn" id="addRectBtn">‚ñ≠ Kotak</button>
        <button class="btn" id="addCircleBtn">‚óØ Lingkar</button>
        <button class="btn" id="addArrowBtn">‚û§ Panah</button>
        <button class="btn" id="addImageBtn">üñºÔ∏è Gambar‚Ä¶</button>
        <input type="file" id="imageInput" accept="image/*" hidden />
      </div>

      <div class="group">
        <label>Warna</label><input type="color" id="strokeColor" class="input" value="#000000" />
        <label>Fill</label><input type="color" id="fillColor" class="input" value="#FFFFFF" />
        <label>Ketebalan</label><input type="number" id="strokeWidth" class="input" min="1" max="20" value="1" style="width:72px" />
      </div>

      <div class="group">
        <label>Font</label>
        <select id="fontFamily" class="select">
          <option value="Inter, system-ui, Arial">Inter / System</option>
          <option value="Arial">Arial</option><option value="Helvetica">Helvetica</option>
          <option value="Times New Roman">Times New Roman</option>
          <option value="Courier New">Courier New</option>
          <option value="Georgia">Georgia</option><option value="Tahoma">Tahoma</option>
        </select>
        <label>Uk.</label><input type="number" id="fontSize" class="input" value="18" min="8" max="120" style="width:72px" />
        <button class="btn" id="boldBtn"><b>B</b></button>
        <button class="btn" id="italicBtn"><i>I</i></button>
      </div>

      <div class="group">
        <button class="btn" id="undoBtn" title="Ctrl+Z">Undo</button>
        <button class="btn" id="redoBtn" title="Ctrl+Y">Redo</button>
        <button class="btn" id="deleteObjBtn">Hapus Objek</button>
      </div>

      <div class="group">
        <button class="btn green" id="downloadPdfBtn">Unduh PDF Hasil</button>
      </div>

      <div class="group">
        <button class="btn" id="zoomOut">‚àí</button>
        <div class="hint" id="zoomPct" style="min-width:44px;text-align:center">100%</div>
        <button class="btn" id="zoomIn">+</button>
        <button class="btn" id="zoomReset">Reset</button>
      </div>
    </div>
  </header>

  <div class="main">
    <aside class="sidebar">
      <div class="side-head"><div><strong>Halaman</strong></div></div>
      <div class="split-bar">
        <div class="hint">Centang untuk <b>Split</b></div>
        <button class="btn" id="downloadSplitBtn" disabled>Download Split</button>
      </div>
      <ul class="thumbs" id="thumbList"></ul>
      <div class="hint" style="margin-top:.6rem">Drag ‚â° untuk urutan. Klik thumbnail untuk edit. üóëÔ∏è untuk hapus halaman.</div>
    </aside>

    <section class="editor">
      <div class="editor-head">
        <div><strong id="pageTitle">Tidak ada PDF</strong></div>
        <div class="hint">Double-click teks untuk edit. Zoom pakai tombol di atas.</div>
      </div>
      <div class="stage" id="stageWrap">
        <canvas id="fabricStage"></canvas>
      </div>
    </section>
  </div>
</div>

<script>
/* ====== State ====== */
const PDF_SCALE = 1.5;
const pages = []; // {id,pdfDoc,pageIndex,sourceName,thumbURL,sizePts,sizePx,fabric,jsonHistory,historyIdx,selectedForSplit}
let currentPageId = null;

/* ====== History ====== */
function pushHistory(p){
  try{
    const json = p.fabric.toJSON(['selectable']);
    if(p.historyIdx < p.jsonHistory.length-1) p.jsonHistory = p.jsonHistory.slice(0, p.historyIdx+1);
    p.jsonHistory.push(json);
    if(p.jsonHistory.length>50) p.jsonHistory.shift();
    p.historyIdx = p.jsonHistory.length-1;
  }catch(e){}
}
function applyHistory(p){ const j=p.jsonHistory[p.historyIdx]; if(!j) return; p.fabric.loadFromJSON(j, ()=>p.fabric.renderAll()); }
const uid = (()=>{ let i=0; return ()=>`p_${Date.now().toString(36)}_${(i++).toString(36)}`;})();

/* ====== Nodes ====== */
const thumbList = document.getElementById('thumbList');
const stageWrap = document.getElementById('stageWrap');
const fabricCanvasEl = document.getElementById('fabricStage');
const pageTitle = document.getElementById('pageTitle');

const pdfInput = document.getElementById('pdfInput');
const pdfInputMerge = document.getElementById('pdfInputMerge');
document.getElementById('openPdfBtn').onclick = ()=> pdfInput.click();
document.getElementById('addMorePdfBtn').onclick = ()=> pdfInputMerge.click();

const addTextBtn = document.getElementById('addTextBtn');
const addRectBtn = document.getElementById('addRectBtn');
const addCircleBtn = document.getElementById('addCircleBtn');
const addArrowBtn = document.getElementById('addArrowBtn');
const addImageBtn = document.getElementById('addImageBtn');
const imageInput = document.getElementById('imageInput');

const strokeColor = document.getElementById('strokeColor');
const fillColor = document.getElementById('fillColor');
const strokeWidth = document.getElementById('strokeWidth');
const fontFamily = document.getElementById('fontFamily');
const fontSize = document.getElementById('fontSize');
const boldBtn = document.getElementById('boldBtn');
const italicBtn = document.getElementById('italicBtn');

const undoBtn = document.getElementById('undoBtn');
const redoBtn = document.getElementById('redoBtn');
const deleteObjBtn = document.getElementById('deleteObjBtn');

const downloadPdfBtn = document.getElementById('downloadPdfBtn');
const downloadSplitBtn = document.getElementById('downloadSplitBtn');
const zoomPct = document.getElementById('zoomPct');

/* ====== Sortable ====== */
new Sortable(thumbList, {
  animation:150, handle:".drag",
  onEnd:()=>{ const order=Array.from(thumbList.querySelectorAll('.thumb')).map(li=>li.dataset.id);
              const m=new Map(pages.map(p=>[p.id,p])); pages.splice(0,pages.length,...order.map(id=>m.get(id))); renderThumbs(); }
});

/* ====== Load PDFs ====== */
pdfInput.onchange = async e=>{ clearAll(); await handlePdfFiles(e.target.files); e.target.value=""; }
pdfInputMerge.onchange = async e=>{ await handlePdfFiles(e.target.files); e.target.value=""; }

async function handlePdfFiles(fileList){
  if(!fileList?.length) return;
  for(const f of fileList){
    const ab = await f.arrayBuffer();
    const bytes = new Uint8Array(ab.slice(0));
    await importPdf(bytes, f.name);
  }
  if(pages.length){ renderThumbs(); openPage(pages[0].id); }
}

async function importPdf(sourceBytes, sourceName){
  const pdfDoc = await PDFLib.PDFDocument.load(sourceBytes);
  const pdf = await pdfjsLib.getDocument({data: sourceBytes}).promise;

  for(let i=1;i<=pdf.numPages;i++){
    const page = await pdf.getPage(i);
    const vpPreview = page.getViewport({scale:PDF_SCALE});
    const vpPts = page.getViewport({scale:1}); // points
    const c = document.createElement('canvas');
    c.width = Math.floor(vpPreview.width);
    c.height = Math.floor(vpPreview.height);
    await page.render({canvasContext:c.getContext('2d',{alpha:false}), viewport:vpPreview}).promise;

    pages.push({
      id: uid(),
      pdfDoc, pageIndex:i-1, sourceName,
      thumbURL: c.toDataURL('image/jpeg',0.85),
      sizePts:{ w: vpPts.width, h: vpPts.height },
      sizePx:{ w: c.width, h: c.height },
      fabric:null, jsonHistory:[], historyIdx:-1, selectedForSplit:false
    });
  }
}

/* ====== Thumbs ====== */
function renderThumbs(){
  thumbList.innerHTML="";
  pages.forEach((p,idx)=>{
    const li=document.createElement('li');
    li.className='thumb'+(p.id===currentPageId?' active':''); li.dataset.id=p.id;
    li.innerHTML=`
      <div class="canvas-wrap"><img src="${p.thumbURL}" alt="Halaman ${idx+1}"></div>
      <div class="meta">
        <div class="title">Hal. ${idx+1}</div>
        <div class="actions">
          <label><input type="checkbox" class="splitChk"${p.selectedForSplit?' checked':''}></label>
          <button class="btn drag" title="Urutkan">‚â°</button>
          <button class="btn red del">üóëÔ∏è</button>
        </div>
      </div>`;
    li.querySelector('.canvas-wrap').onclick=()=>openPage(p.id);
    li.querySelector('.del').onclick=()=>{ const ix=pages.findIndex(x=>x.id===p.id); if(ix>=0){ pages.splice(ix,1); renderThumbs(); if(pages.length) openPage(pages[Math.min(ix,pages.length-1)].id); else clearEditor(); } };
    li.querySelector('.splitChk').onchange=e=>{ p.selectedForSplit=e.target.checked; toggleSplitBtn(); };
    thumbList.appendChild(li);
  });
  toggleSplitBtn();
}
function toggleSplitBtn(){ downloadSplitBtn.disabled=!pages.some(p=>p.selectedForSplit); }

/* ====== Editor & Zoom (pakai Fabric viewport, bukan CSS) ====== */
let zoomScale = 1;
function setZoom(f, scale){
  zoomScale = Math.min(3, Math.max(0.2, scale));
  f.setViewportTransform([zoomScale,0,0,zoomScale,0,0]); // akurat untuk pointer
  zoomPct.textContent = Math.round(zoomScale*100)+'%';
  f.requestRenderAll();
}
function autoFitToWidth(p){
  const wrapW = Math.max(200, stageWrap.clientWidth - 24);
  const scale = wrapW / p.sizePx.w;
  setZoom(p.fabric, scale);
}
window.addEventListener('resize', ()=>{ const p=getActivePage(); if(p?.fabric) autoFitToWidth(p); });

function clearEditor(){
  pageTitle.textContent="Tidak ada PDF";
  currentPageId=null;
  if(window._activeFabric){ window._activeFabric.dispose(); window._activeFabric=null; }
  fabricCanvasEl.width=600; fabricCanvasEl.height=800;
  fabricCanvasEl.style.width="600px"; fabricCanvasEl.style.height="800px";
}

async function openPage(id){
  const p = pages.find(x=>x.id===id); if(!p) return;
  currentPageId=id;
  Array.from(thumbList.querySelectorAll('.thumb')).forEach(li=>li.classList.toggle('active', li.dataset.id===id));
  pageTitle.textContent=`${p.sourceName||'Dokumen'} ‚Äì Halaman ${pages.indexOf(p)+1}`;

  if(window._activeFabric){ window._activeFabric.dispose(); window._activeFabric=null; }

  fabricCanvasEl.width=p.sizePx.w; fabricCanvasEl.height=p.sizePx.h;
  fabricCanvasEl.style.width=p.sizePx.w+"px"; fabricCanvasEl.style.height=p.sizePx.h+"px";

  const f = new fabric.Canvas('fabricStage', {
    backgroundColor: null,
    selection: true, preserveObjectStacking: true,
    enableRetinaScaling: true
  });
  window._activeFabric=f; p.fabric=f;

  fabric.Image.fromURL(p.thumbURL, img=>{
    f.setBackgroundImage(img, f.renderAll.bind(f), {originX:'left',originY:'top',left:0,top:0,scaleX:1,scaleY:1});
  });

  if(p.jsonHistory.length===0) pushHistory(p);
  const push=()=>pushHistory(p);
  f.on('object:added',e=>{ if(!e?.target?._skipHistory) push(); });
  f.on('object:modified',push);
  f.on('object:removed',push);

  // sinkron kontrol saat pilih objek
  f.on('selection:created', syncControlsFromActive);
  f.on('selection:updated', syncControlsFromActive);

  autoFitToWidth(p);

  // tombol zoom
  document.getElementById('zoomIn').onclick = ()=> setZoom(f, zoomScale+0.1);
  document.getElementById('zoomOut').onclick = ()=> setZoom(f, zoomScale-0.1);
  document.getElementById('zoomReset').onclick = ()=> setZoom(f, 1);
}

/* ====== Tools ====== */
function getActivePage(){ return pages.find(x=>x.id===currentPageId); }
function getFabric(){ return getActivePage()?.fabric; }
function applyStrokeFill(obj){
  obj.set({
    stroke: strokeColor.value,
    fill: (obj.type==='textbox' ? fillColor.value : (obj.type==='path' ? 'transparent' : fillColor.value)),
    strokeWidth: parseFloat(strokeWidth.value||'2'),
    transparentCorners:false, cornerStyle:'circle', cornerSize:10
  });
}
addTextBtn.onclick=()=>{
  const f=getFabric(); if(!f) return;
  const t=new fabric.Textbox('Teks',{left:60,top:60,fontSize:parseInt(fontSize.value||'18',10),
    fontFamily:fontFamily.value,fontWeight:boldBtn.classList.contains('on')?'bold':'normal',
    fontStyle:italicBtn.classList.contains('on')?'italic':'normal',
    fill:fillColor.value, editable:true});
  applyStrokeFill(t); f.add(t).setActiveObject(t).renderAll();
};
addRectBtn.onclick=()=>{ const f=getFabric(); if(!f) return; const r=new fabric.Rect({left:80,top:80,width:140,height:80,fill:'transparent'}); applyStrokeFill(r); f.add(r).setActiveObject(r).renderAll(); };
addCircleBtn.onclick=()=>{ const f=getFabric(); if(!f) return; const c=new fabric.Circle({left:120,top:120,radius:50,fill:'transparent'}); applyStrokeFill(c); f.add(c).setActiveObject(c).renderAll(); };
addArrowBtn.onclick=()=>{
  const f=getFabric(); if(!f) return;
  const line=new fabric.Line([0,0,160,0],{stroke:strokeColor.value,strokeWidth:parseFloat(strokeWidth.value||'2'),selectable:false});
  const tri=new fabric.Triangle({width:18,height:18,fill:strokeColor.value,left:160,top:-9,angle:90,selectable:false});
  const grp=new fabric.Group([line,tri],{left:140,top:140,hasRotatingPoint:true}); grp._skipHistory=true;
  f.add(grp).setActiveObject(grp).renderAll();
};
addImageBtn.onclick=()=> imageInput.click();
imageInput.onchange=async e=>{
  const f=getFabric(); if(!f) return;
  const file=e.target.files?.[0]; if(!file) return;
  const dataURL = await new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); });
  fabric.Image.fromURL(dataURL, img=>{ img.set({left:100,top:100,scaleX:.5,scaleY:.5}); applyStrokeFill(img); f.add(img).setActiveObject(img).renderAll(); imageInput.value=""; }, {crossOrigin:'anonymous'});
};

/* ====== Controls realtime (warna teks langsung berubah) ====== */
function syncControlsFromActive(){
  const o=getFabric()?.getActiveObject(); if(!o) return;
  if('stroke' in o && o.stroke) strokeColor.value = toHex(o.stroke);
  if('fill' in o && o.fill) fillColor.value = toHex(o.fill);
  if('strokeWidth' in o && o.strokeWidth) strokeWidth.value = o.strokeWidth;
  if(o.type==='textbox'){ fontFamily.value=o.fontFamily||fontFamily.value; fontSize.value=o.fontSize||fontSize.value;
    toggleBtn(boldBtn, o.fontWeight==='bold'); toggleBtn(italicBtn, o.fontStyle==='italic'); }
}
function toggleBtn(btn, on){ btn.classList.toggle('on', !!on); }
function toHex(col){ const ctx=document.createElement('canvas').getContext('2d'); ctx.fillStyle=col; return ctx.fillStyle; }

// ‚ÄúWarna‚Äù ‚Üí untuk teks = warna huruf; untuk shape = stroke
strokeColor.addEventListener('input', ()=>{
  const f=getFabric(); const o=f?.getActiveObject(); if(!o) return;
  if(o.type==='textbox'){ o.set('fill', strokeColor.value); } // langsung ganti warna teks
  else { o.set('stroke', strokeColor.value); if(o.type==='group'){ o._objects?.forEach(ob=>{ if('stroke'in ob) ob.set('stroke', strokeColor.value); if(ob.type==='triangle') ob.set('fill', strokeColor.value); }); } }
  f.renderAll();
});
fillColor.addEventListener('input', ()=>{ const o=getFabric()?.getActiveObject(); if(o){ o.set('fill', fillColor.value); getFabric().renderAll(); }});
strokeWidth.addEventListener('change', ()=>{
  const f=getFabric(); const o=f?.getActiveObject(); if(!o) return;
  o.set('strokeWidth', parseFloat(strokeWidth.value||'2')); if(o.type==='group'){ o._objects?.forEach(ob=>{ if('strokeWidth'in ob) ob.set('strokeWidth', parseFloat(strokeWidth.value||'2')); }); }
  f.renderAll();
});
fontFamily.addEventListener('change', ()=>{ const o=getFabric()?.getActiveObject(); if(o?.type==='textbox'){ o.set('fontFamily', fontFamily.value); getFabric().renderAll(); }});
fontSize.addEventListener('change', ()=>{ const o=getFabric()?.getActiveObject(); if(o?.type==='textbox'){ o.set('fontSize', parseInt(fontSize.value||'18',10)); getFabric().renderAll(); }});
boldBtn.addEventListener('click', ()=>{ boldBtn.classList.toggle('on'); const o=getFabric()?.getActiveObject(); if(o?.type==='textbox'){ o.set('fontWeight', boldBtn.classList.contains('on')?'bold':'normal'); getFabric().renderAll(); }});
italicBtn.addEventListener('click', ()=>{ italicBtn.classList.toggle('on'); const o=getFabric()?.getActiveObject(); if(o?.type==='textbox'){ o.set('fontStyle', italicBtn.classList.contains('on')?'italic':'normal'); getFabric().renderAll(); }});

/* ====== Edit actions ====== */
undoBtn.onclick=()=>{ const p=getActivePage(); if(p&&p.historyIdx>0){ p.historyIdx--; applyHistory(p); } };
redoBtn.onclick=()=>{ const p=getActivePage(); if(p&&p.historyIdx<p.jsonHistory.length-1){ p.historyIdx++; applyHistory(p); } };
deleteObjBtn.onclick=()=>{ const f=getFabric(); const o=f?.getActiveObject(); if(o){ f.remove(o); f.discardActiveObject(); f.requestRenderAll(); } };

/* ====== Export (overlay transparan + zoom aman) ====== */
downloadPdfBtn.onclick = async ()=>{
  if(!pages.length) return;
  const { PDFDocument } = PDFLib;
  const out = await PDFDocument.create();

  for(const p of pages){
    const [copied] = await out.copyPages(p.pdfDoc, [p.pageIndex]);
    out.addPage(copied);
    if(p.fabric){
      const page = out.getPage(out.getPageCount()-1);
      const oldVT = p.fabric.viewportTransform;           // simpan zoom
      p.fabric.setViewportTransform([1,0,0,1,0,0]);        // export pada skala 1 supaya tajam
      const bgImg=p.fabric.backgroundImage; const bgCol=p.fabric.backgroundColor;
      if(bgImg) p.fabric.setBackgroundImage(null, p.fabric.renderAll.bind(p.fabric));
      p.fabric.setBackgroundColor(null);
      const overlayURL = p.fabric.toDataURL({ format:'png' });
      if(bgImg) p.fabric.setBackgroundImage(bgImg, p.fabric.renderAll.bind(p.fabric));
      p.fabric.setBackgroundColor(bgCol);
      p.fabric.setViewportTransform(oldVT);               // restore zoom

      const pngBytes = await (await fetch(overlayURL)).arrayBuffer();
      const pngImg = await out.embedPng(pngBytes);
      page.drawImage(pngImg, { x:0, y:0, width:p.sizePts.w, height:p.sizePts.h });
    }
  }
  const bytes = await out.save();
  downloadBlob(new Blob([bytes], {type:'application/pdf'}), `edited-${Date.now()}.pdf`);
};

/* ====== Split ====== */
downloadSplitBtn.onclick = async ()=>{
  const targets = pages.filter(p=>p.selectedForSplit);
  if(!targets.length) return;
  const { PDFDocument } = PDFLib;
  const out = await PDFDocument.create();

  for(const p of targets){
    const [copied] = await out.copyPages(p.pdfDoc, [p.pageIndex]);
    out.addPage(copied);
    if(p.fabric){
      const page = out.getPage(out.getPageCount()-1);
      const oldVT = p.fabric.viewportTransform;
      p.fabric.setViewportTransform([1,0,0,1,0,0]);
      const bgImg=p.fabric.backgroundImage; const bgCol=p.fabric.backgroundColor;
      if(bgImg) p.fabric.setBackgroundImage(null, p.fabric.renderAll.bind(p.fabric));
      p.fabric.setBackgroundColor(null);
      const overlayURL = p.fabric.toDataURL({ format:'png' });
      if(bgImg) p.fabric.setBackgroundImage(bgImg, p.fabric.renderAll.bind(p.fabric));
      p.fabric.setBackgroundColor(bgCol);
      p.fabric.setViewportTransform(oldVT);

      const pngBytes = await (await fetch(overlayURL)).arrayBuffer();
      const pngImg = await out.embedPng(pngBytes);
      page.drawImage(pngImg, { x:0, y:0, width:p.sizePts.w, height:p.sizePts.h });
    }
  }
  const bytes = await out.save();
  downloadBlob(new Blob([bytes], {type:'application/pdf'}), `split-${Date.now()}.pdf`);
};

/* ====== Helpers ====== */
function downloadBlob(blob, filename){
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=filename;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
}
function clearAll(){ pages.splice(0,pages.length); renderThumbs(); clearEditor(); }

/* ====== Shortcuts ====== */
document.addEventListener('keydown', (e)=>{
  const f=getFabric(); if(!f) return;
  if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='z'){ e.preventDefault(); undoBtn.click(); }
  if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='y'){ e.preventDefault(); redoBtn.click(); }
  if(e.key==='Delete'||e.key==='Backspace'){ const o=f.getActiveObject(); if(o){ e.preventDefault(); f.remove(o); f.requestRenderAll(); } }
});
</script>
</body>
</html>
