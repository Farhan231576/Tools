<!doctype html>
<html lang="id" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Undian Spin Wheel</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <style>
    :root{
      --wheel-size: 540px; /* disk base size; will scale responsif */
      --panel-w: 420px;
    }

    html,body{height:100%;}
    body{overflow:hidden;}

    /* Layout utama agar muat 1366×768 tanpa scroll; tabel riwayat scroll internal */
    .app-wrap{height:100dvh; display:grid; grid-template-columns: 1fr var(--panel-w); grid-template-rows: auto 1fr; grid-template-areas:
      "toolbar toolbar" 
      "stage side";}

    @media (max-width: 1200px){
      :root{--panel-w: 380px}
    }
    @media (max-width: 992px){ /* fallback perangkat kecil */
      body{overflow:auto}
      .app-wrap{grid-template-columns: 1fr; grid-template-rows:auto auto auto; grid-template-areas:
        "toolbar" "stage" "side"; height:auto}
    }

    .toolbar{grid-area:toolbar; border-bottom:1px solid var(--bs-border-color);}
    .stage{grid-area:stage; display:grid; place-items:center; padding:8px}
    .side{grid-area:side; border-left:1px solid var(--bs-border-color); overflow:auto}

    /* Wheel container */
    .wheel-wrap{display:grid; place-items:center; width:100%;}
    .wheel-outer{position:relative; aspect-ratio:1/1; max-width: min(90vw, var(--wheel-size));}
    canvas#wheel{width:100%; height:100%;}

    /* Pointer panah di tengah */
    .pointer{position:absolute; inset:0; display:grid; place-items:center; pointer-events:none}
    .pointer svg{width:68px; height:68px; filter: drop-shadow(0 2px 6px rgba(0,0,0,.25));}

    /* Panel samping */
    .side .accordion-button{font-weight:600}

    /* Ringkasan */
    .stat-pill{display:flex; align-items:center; gap:.5rem; padding:.5rem .75rem; border-radius:999px; border:1px solid var(--bs-border-color);}

    /* Tabel riwayat */
    .history-wrap{height: 38vh; overflow:auto;}
    .table-fixed thead th{position: sticky; top: 0; background: var(--bs-body-bg); z-index: 2}

    /* Fokus & aksesibilitas */
    .btn,.form-control,.form-select{min-height:42px}
    .form-range{height:2rem}

    /* Dark-mode high-contrast tweak */
    [data-bs-theme="dark"] .table > :not(caption) > * > *{background-color:rgba(255,255,255,.015)}

    /* winner highlight */
    .winner-badge{font-weight:700;}
  </style>
</head>
<body>
<div class="app-wrap">
  <!-- Toolbar: Tema, Suara, Konfeti, Speed, Aksi -->
  <div class="toolbar py-2 px-3 d-flex align-items-center gap-2 flex-wrap">
    <div class="me-auto d-flex align-items-center gap-2">
      <span class="fw-semibold">Undian Spin Wheel</span>
      <span class="text-body-secondary">&middot; Bootstrap + JS</span>
    </div>
    <div class="d-flex align-items-center gap-3">
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" role="switch" id="toggleTheme">
        <label class="form-check-label" for="toggleTheme">Dark</label>
      </div>
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" role="switch" id="toggleSound" checked>
        <label class="form-check-label" for="toggleSound">Suara</label>
      </div>
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" role="switch" id="toggleConfetti" checked>
        <label class="form-check-label" for="toggleConfetti">Konfeti</label>
      </div>
      <div class="d-flex align-items-center gap-2">
        <label for="speed" class="form-label m-0">Lama Spin</label>
        <input type="range" class="form-range" id="speed" min="1500" max="7000" step="100" value="3000" style="width:220px">
      </div>
      <button id="btnUndo" type="button" class="btn btn-outline-secondary" title="Undo terakhir" disabled>
        Undo
      </button>
      <button id="btnSpin" type="button" class="btn btn-primary px-4 fw-semibold" disabled>
        SPIN
      </button>
    </div>
  </div>

  <!-- Stage: Wheel  -->
  <div class="stage">
    <div class="wheel-wrap">
      <div class="wheel-outer">
        <canvas id="wheel" width="1000" height="1000" aria-label="Roda Undian" role="img"></canvas>
        <div class="pointer" aria-hidden="true">
          <!-- SVG panah pusat -->
          <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0" stop-color="#111"/>
                <stop offset="1" stop-color="#555"/>
              </linearGradient>
            </defs>
            <circle cx="50" cy="50" r="18" fill="url(#g)" stroke="#fff" stroke-width="2"/>
            <path d="M50 2 L58 22 L42 22 Z" fill="#dc3545" stroke="#fff" stroke-width="2"/>
          </svg>
        </div>
      </div>
    </div>
  </div>

  <!-- Side: Config + Info + History -->
  <div class="side p-3">
    <div class="accordion" id="configAccordion">
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingImport">
          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseImport" aria-expanded="true" aria-controls="collapseImport">
            Import / Export Data
          </button>
        </h2>
        <div id="collapseImport" class="accordion-collapse collapse show" aria-labelledby="headingImport" data-bs-parent="#configAccordion">
          <div class="accordion-body">
            <div class="row g-2 align-items-end">
              <div class="col-12">
                <label class="form-label fw-semibold">Peserta (.xlsx / .csv)</label>
              </div>
              <div class="col-8">
                <input type="file" id="filePeserta" accept=".xlsx,.csv" class="form-control">
              </div>
              <div class="col-4 d-grid gap-2">
                <button class="btn btn-outline-secondary" id="btnDownloadPesertaSample">Unduh Contoh</button>
                <button class="btn btn-outline-danger" id="btnClearPeserta">Bersihkan</button>
              </div>
              <div class="col-12 mt-2">
                <textarea id="pastePeserta" class="form-control" rows="3" placeholder="Paste cepat peserta: NPK,Nama,Department per baris (tak perlu header)"></textarea>
                <div class="d-grid mt-1"><button class="btn btn-sm btn-outline-primary" id="btnParsePeserta">Parse Peserta</button></div>
              </div>
              <hr class="my-2"/>
              <div class="col-12">
                <label class="form-label fw-semibold">Hadiah (.xlsx / .csv)</label>
              </div>
              <div class="col-8">
                <input type="file" id="fileHadiah" accept=".xlsx,.csv" class="form-control">
              </div>
              <div class="col-4 d-grid gap-2">
                <button class="btn btn-outline-secondary" id="btnDownloadHadiahSample">Unduh Contoh</button>
                <button class="btn btn-outline-danger" id="btnClearHadiah">Bersihkan</button>
              </div>
              <div class="col-12 mt-2">
                <textarea id="pasteHadiah" class="form-control" rows="3" placeholder="Paste cepat hadiah: NamaHadiah,Jumlah,WarnaHex? per baris (tak perlu header)"></textarea>
                <div class="d-grid mt-1"><button class="btn btn-sm btn-outline-primary" id="btnParseHadiah">Parse Hadiah</button></div>
              </div>
              <hr class="my-2"/>
              <div class="col-12 d-grid">
                <button class="btn btn-success" id="btnExportWinners">Export Winners (.xlsx / .csv)</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="accordion-item">
        <h2 class="accordion-header" id="headingSummary">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSummary" aria-expanded="false" aria-controls="collapseSummary">
            Ringkasan & Validasi
          </button>
        </h2>
        <div id="collapseSummary" class="accordion-collapse collapse" aria-labelledby="headingSummary" data-bs-parent="#configAccordion">
          <div class="accordion-body">
            <div class="d-flex flex-column gap-2">
              <div class="stat-pill"><span class="badge text-bg-primary">Peserta unik</span><span id="statPeserta">0</span></div>
              <div class="stat-pill"><span class="badge text-bg-warning">Total hadiah</span><span id="statHadiah">0</span></div>
              <div class="stat-pill"><span class="badge text-bg-success">Hadiah tersisa</span><span id="statHadiahSisa">0</span></div>
              <div class="stat-pill"><span class="badge text-bg-secondary">Peserta belum menang</span><span id="statUnwon">0</span></div>
            </div>
          </div>
        </div>
      </div>

      <div class="accordion-item">
        <h2 class="accordion-header" id="headingHistory">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseHistory" aria-expanded="false" aria-controls="collapseHistory">
            Hasil & Riwayat
          </button>
        </h2>
        <div id="collapseHistory" class="accordion-collapse collapse" aria-labelledby="headingHistory" data-bs-parent="#configAccordion">
          <div class="accordion-body">
            <div class="history-wrap">
              <table class="table table-sm align-middle table-striped table-fixed" id="tblHistory">
                <thead>
                  <tr>
                    <th>Waktu</th>
                    <th>Hadiah</th>
                    <th>Jumlah</th>
                    <th>Nama / NPK / Dept</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Winner Overlay -->
<div class="modal fade" id="winnerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Pemenang</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="winnerSummary" class="mb-2"></div>
        <div class="table-responsive" style="max-height:40vh">
          <table class="table table-sm">
            <thead><tr><th>#</th><th>Nama</th><th>NPK</th><th>Department</th></tr></thead>
            <tbody id="winnerList"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
        <button type="button" class="btn btn-primary" id="btnSaveContinue">Simpan & Lanjut</button>
      </div>
    </div>
  </div>
</div>

<!-- Libs: Bootstrap, XLSX, Confetti -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

<script>
/**
 * =============================
 *  STATE & PERSISTENCE LAYER
 * =============================
 */
const LS_KEY = 'spinwheel_state_v1';
const defaultState = {
  theme: 'light',
  sound: true,
  confetti: true,
  participants: [], // {npk, nama, dept, won:boolean}
  prizes: [],       // {name, qty, color, remain}
  history: [],      // {ts, prize, qty, winners:[participant]}
};
let state = loadState();
let undoBuffer = null; // one-level undo snapshot

function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
function loadState(){
  try{ const s = JSON.parse(localStorage.getItem(LS_KEY)); if(s) return s; }catch{}
  return structuredClone(defaultState);
}
function resetParticipants(){ state.participants = []; saveState(); refreshStats(); }
function resetPrizes(){ state.prizes = []; saveState(); refreshStats(); drawWheel(); }

/**
 * =============================
 *  UTILITIES
 * =============================
 */
const rng = (maxExclusive)=>{
  // crypto RNG uniform [0, max)
  const buf = new Uint32Array(1); crypto.getRandomValues(buf);
  return Math.floor(buf[0] / 2**32 * maxExclusive);
};
const rngFloat = ()=>{ const b = new Uint32Array(1); crypto.getRandomValues(b); return b[0]/2**32; };

function nowTS(){ return new Date().toISOString(); }

function dedupeParticipants(list){
  const seen = new Set();
  const out = [];
  for(const p of list){
    if(!p.npk) continue;
    if(seen.has(p.npk)) continue; // ambil entri pertama, sisanya diabaikan
    seen.add(p.npk);
    out.push({...p, won: !!p.won});
  }
  return out;
}

function normalizePrizes(list){
  const byName = new Map();
  for(const it of list){
    const name = (it.name||'').trim();
    const qty = Math.max(0, Number(it.qty||0)|0);
    if(!name || qty<=0) continue;
    const color = it.color ? it.color.trim() : colorFromString(name);
    if(!byName.has(name)) byName.set(name, {name, qty:0, color, remain:0});
    const obj = byName.get(name);
    obj.qty += qty; obj.remain += qty; // gabungkan item berganda
    if(!it.color) obj.color = colorFromString(name); // konsistensi warna
  }
  return [...byName.values()];
}

function colorFromString(s){
  // Deterministik: hash -> HSL -> hex
  let h = 0; for(let i=0;i<s.length;i++) h = Math.imul(31,h) + s.charCodeAt(i) | 0;
  h = (h>>>0) % 360; const sat = 72, light = 55;
  return hslToHex(h, sat, light);
}
function hslToHex(h,s,l){
  s/=100;l/=100; const c=(1-Math.abs(2*l-1))*s, x=c*(1-Math.abs((h/60)%2-1)), m=l-c/2;
  let [r,g,b]=h<60?[c,x,0]:h<120?[x,c,0]:h<180?[0,c,x]:h<240?[0,x,c]:h<300?[x,0,c]:[c,0,x];
  r=Math.round((r+m)*255); g=Math.round((g+m)*255); b=Math.round((b+m)*255);
  return '#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');
}

function fmtTime(ts){ const d=new Date(ts); return d.toLocaleString(); }

/**
 * =============================
 *  IMPORT / EXPORT HELPERS
 * =============================
 */
async function parseFile(file, type){
  const ext = file.name.split('.').pop().toLowerCase();
  const buf = await file.arrayBuffer();
  if(ext==='csv'){
    const text = new TextDecoder().decode(buf);
    return parseCSV(text);
  } else { // xlsx
    const wb = XLSX.read(buf, {type:'array'});
    const ws = wb.Sheets[wb.SheetNames[0]];
    return XLSX.utils.sheet_to_json(ws, {defval:''});
  }
}

function parseCSV(text){
  // sederhana, split baris + koma (tidak menangani koma quoted kompleks)
  const lines = text.split(/\r?\n/).filter(Boolean);
  if(!lines.length) return [];
  const maybeHeader = lines[0].split(',');
  let hasHeader = false;
  const head = maybeHeader.map(h=>h.trim().toLowerCase());
  if(head.includes('npk')||head.includes('namahadiah')) hasHeader=true;
  const rows = hasHeader? lines.slice(1): lines;
  return rows.map(r=>{
    const cols = r.split(',').map(c=>c.trim());
    return cols;
  });
}

function parseParticipantsFromAny(data){
  // data bisa array of array (CSV tanpa header), atau array of objects (XLSX)
  const out = [];
  if(!data) return out;
  if(Array.isArray(data) && data.length && Array.isArray(data[0])){
    for(const row of data){ if(row.length<2) continue; out.push({npk: String(row[0]||''), nama: row[1]||'', dept: row[2]||''}); }
  } else {
    for(const obj of data){
      const npk = String(obj.NPK ?? obj.npk ?? obj["NPK"] ?? '');
      const nama = String(obj.Nama ?? obj.nama ?? obj["Nama"] ?? '');
      const dept = String(obj.Department ?? obj.department ?? obj["Department"] ?? '');
      if(npk && nama) out.push({npk, nama, dept});
    }
  }
  return out;
}

function parsePrizesFromAny(data){
  const out=[];
  if(!data) return out;
  if(Array.isArray(data) && data.length && Array.isArray(data[0])){
    for(const row of data){ if(row.length<2) continue; out.push({name: row[0]||'', qty: row[1]||0, color: row[2]||''}); }
  } else {
    for(const obj of data){
      const name = String(obj.NamaHadiah ?? obj.namaHadiah ?? obj.name ?? obj["NamaHadiah"] ?? '');
      const qty = Number(obj.Jumlah ?? obj.jumlah ?? obj.qty ?? obj["Jumlah"] ?? 0) || 0;
      const color = String(obj.WarnaHex ?? obj.warnaHex ?? obj.color ?? obj["WarnaHex"] ?? '');
      if(name && qty>0) out.push({name, qty, color});
    }
  }
  return out;
}

function exportWinners(){
  if(!state.history.length){ alert('Belum ada pemenang.'); return; }
  const rows = [];
  for(const item of state.history){
    const base = {Waktu: fmtTime(item.ts), Hadiah: item.prize, Jumlah: item.qty};
    if(item.winners.length===0){ rows.push(base); continue; }
    item.winners.forEach(w=>{
      rows.push({...base, NPK: w.npk, Nama: w.nama, Department: w.dept});
    });
  }
  // XLSX
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Winners');
  const fnameX = `winners_${new Date().toISOString().replace(/[:.]/g,'-')}.xlsx`;
  XLSX.writeFile(wb, fnameX);
  // CSV
  const csv = XLSX.utils.sheet_to_csv(ws);
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = fnameX.replace('.xlsx','.csv'); a.click(); URL.revokeObjectURL(a.href);
}

function downloadSample(kind){
  if(kind==='peserta'){
    const rows = [
      {NPK:'1001', Nama:'Budi Santoso', Department:'Finance'},
      {NPK:'1002', Nama:'Siti Aminah', Department:'HR'},
      {NPK:'1003', Nama:'Andi Wijaya', Department:'IT'}
    ];
    const ws = XLSX.utils.json_to_sheet(rows); const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Peserta'); XLSX.writeFile(wb, 'peserta-sample.xlsx');
  } else {
    const rows = [
      {NamaHadiah:'Motor', Jumlah:1, WarnaHex:'#D81B60'},
      {NamaHadiah:'Kulkas', Jumlah:1, WarnaHex:'#1E88E5'},
      {NamaHadiah:'Rumah',  Jumlah:2, WarnaHex:'#43A047'},
      {NamaHadiah:'TV',     Jumlah:5, WarnaHex:'#FB8C00'},
      {NamaHadiah:'Lemari', Jumlah:1, WarnaHex:'#8E24AA'}
    ];
    const ws = XLSX.utils.json_to_sheet(rows); const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Hadiah'); XLSX.writeFile(wb, 'hadiah-sample.xlsx');
  }
}

/**
 * =============================
 *  WHEEL RENDERING (Canvas)
 *  - Satu sektor per jenis hadiah
 *  - Sudut proporsional stok tersisa
 *  - Warna konsisten
 * =============================
 */
const wheel = document.getElementById('wheel');
const ctx = wheel.getContext('2d');
let rotation = -Math.PI/2; // 12 o'clock reference
let spinning = false;

function getActivePrizes(){ return state.prizes.filter(p=>p.remain>0); }

function computeSectors(){
  const active = getActivePrizes();
  const total = active.reduce((a,b)=>a+b.remain,0);
  let acc = 0; const sectors = [];
  for(const p of active){
    const frac = p.remain / total; const start = acc; const end = acc + frac * Math.PI*2;
    sectors.push({name:p.name, color:p.color, startAngle:start, endAngle:end, remain:p.remain});
    acc = end;
  }
  return sectors;
}

function drawWheel(){
  const size = wheel.width; const r = size/2; ctx.clearRect(0,0,size,size);
  ctx.save(); ctx.translate(r,r); ctx.rotate(rotation);
  const sectors = computeSectors();
  // disk background
  ctx.beginPath(); ctx.arc(0,0,r-4,0,Math.PI*2); ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--bs-tertiary-bg')||'#f8f9fa'; ctx.fill();

  // sectors
  sectors.forEach((s,i)=>{
    ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,r-8, s.startAngle, s.endAngle); ctx.closePath();
    ctx.fillStyle = s.color; ctx.fill();
    // border
    ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.stroke();

    // label rotasi tengah sektor
    const mid = (s.startAngle + s.endAngle)/2; ctx.save(); ctx.rotate(mid); ctx.translate((r-8)*0.62, 0);
    ctx.rotate(Math.PI/2); // tegak
    ctx.fillStyle = '#fff';
    ctx.font = '600 18px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
    const label = `${s.name}${s.remain>1?` ×${s.remain}`:''}`;
    // background label
    const metrics = ctx.measureText(label); const pad=6, lh=22; const w=metrics.width+pad*2;
    ctx.fillStyle = 'rgba(0,0,0,0.35)'; ctx.fillRect(-w/2, -lh/2, w, lh);
    ctx.fillStyle = '#fff'; ctx.fillText(label, -metrics.width/2, 7);
    ctx.restore();
  });

  // rim & center
  ctx.beginPath(); ctx.arc(0,0,r-4,0,Math.PI*2); ctx.strokeStyle='rgba(0,0,0,0.25)'; ctx.lineWidth=6; ctx.stroke();
  ctx.beginPath(); ctx.arc(0,0,30,0,Math.PI*2); ctx.fillStyle='#fff'; ctx.fill(); ctx.strokeStyle='rgba(0,0,0,0.2)'; ctx.stroke();

  ctx.restore();
}

function pointToPrize(targetSector){
  // hitung sudut global yang diperlukan agar pointer (atas) berhenti pada tengah sektor
  const sectors = computeSectors();
  const s = sectors[targetSector]; if(!s) return rotation;
  const mid = (s.startAngle + s.endAngle)/2; // di koordinat wheel sebelum rotasi
  // Kita ingin mid berada pada -PI/2 (12 o'clock) setelah rotasi baru
  const targetRotation = -Math.PI/2 - mid; 
  return targetRotation;
}

/**
 * =============================
 *  CORE DRAW LOGIC (Weighted)
 *  - Pilih hadiah berdasar bobot stok tersisa
 *  - Tentukan sudut target
 *  - Saat selesai: pilih pemenang unik = min(stok, peserta sisa)
 * =============================
 */
function choosePrizeIndex(){
  const active = getActivePrizes();
  const total = active.reduce((a,b)=>a+b.remain,0);
  if(total<=0) return -1;
  let rnum = rng(total); // integer [0,total)
  for(let i=0;i<active.length;i++){
    const c = active[i];
    if(rnum < c.remain) return i; rnum -= c.remain;
  }
  return active.length-1;
}

function pickWinnersForPrize(prize){
  const available = state.participants.filter(p=>!p.won);
  const need = Math.min(prize.remain, available.length);
  const chosen = [];
  for(let i=0;i<need;i++){
    const idx = rng(available.length);
    const [p] = available.splice(idx,1);
    p.won = true; chosen.push({...p});
  }
  prize.remain -= chosen.length;
  return chosen;
}

async function spin(){
  if(spinning) return; if(getActivePrizes().length===0){ alert('Tidak ada hadiah tersisa.'); return; }
  if(state.participants.filter(p=>!p.won).length===0){ alert('Tidak ada peserta tersisa.'); return; }
  // snapshot untuk undo
  undoBuffer = JSON.stringify(state);
  document.getElementById('btnUndo').disabled = false;

  spinning = true; setControlsDisabled(true);
  const spinMs = Number(document.getElementById('speed').value);
  const chosenIdx = choosePrizeIndex();
  const sectors = computeSectors();
  // map chosenIdx (pada active prizes) ke indeks sektor yang sama
  const targetRotation = pointToPrize(chosenIdx);
  // tambahkan keliling ekstra agar animasi berputar beberapa kali
  const extraTurns = 4 + Math.floor(rngFloat()*2); // 4-5 putaran
  const start = rotation; const end = targetRotation - extraTurns * Math.PI*2;

  const startTime = performance.now();
  const easeOutCubic = t=>1- Math.pow(1-t,3);

  let rafId;
  function animate(ts){
    const t = Math.min(1, (ts-startTime)/spinMs);
    const eased = easeOutCubic(t);
    rotation = start + (end-start)*eased;
    drawWheel();
    if(t<1){ rafId = requestAnimationFrame(animate); }
    else { cancelAnimationFrame(rafId); onSpinEnd(chosenIdx); }
  }
  rafId = requestAnimationFrame(animate);
}

function onSpinEnd(chosenIdx){
  const prize = getActivePrizes()[chosenIdx];
  if(!prize){ spinning=false; setControlsDisabled(false); return; }
  const winners = pickWinnersForPrize(prize);
  // efek
  if(state.confetti){ fireConfetti(); }
  if(state.sound){ playWinSound(); }
  // tampilkan overlay pemenang
  showWinnersModal(prize.name, winners);
  // update history (sementara simpan, final saat Simpan & Lanjut)
  pendingResult = { ts: nowTS(), prize: prize.name, qty: winners.length, winners };
  refreshStats(); drawWheel();
}

function fireConfetti(){
  const duration = 1500; const end = Date.now() + duration;
  (function frame(){
    confetti({particleCount: 30, spread: 60, startVelocity: 35, origin: {x: Math.random(), y: 0}});
    if(Date.now()<end) requestAnimationFrame(frame);
  })();
}

function playWinSound(){
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const o = ctx.createOscillator(); const g = ctx.createGain(); o.type='triangle'; o.connect(g); g.connect(ctx.destination);
    o.frequency.value = 880; g.gain.setValueAtTime(0.0001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.02);
    o.start(); o.frequency.exponentialRampToValueAtTime(440, ctx.currentTime+0.15);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.2);
    o.stop(ctx.currentTime+0.25);
  }catch{}
}

let pendingResult = null;
function showWinnersModal(prizeName, winners){
  const sum = document.getElementById('winnerSummary');
  sum.innerHTML = `<span class="winner-badge badge text-bg-success">${prizeName}</span> &middot; ${winners.length} pemenang`;
  const tbody = document.getElementById('winnerList'); tbody.innerHTML='';
  winners.forEach((w,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(w.nama)}</td><td>${escapeHtml(w.npk)}</td><td>${escapeHtml(w.dept)}</td>`;
    tbody.appendChild(tr);
  });
  const modal = bootstrap.Modal.getOrCreateInstance('#winnerModal'); modal.show();
}

function pushHistory(item){ state.history.unshift(item); saveState(); renderHistory(); }

function renderHistory(){
  const tbody = document.querySelector('#tblHistory tbody'); tbody.innerHTML='';
  for(const row of state.history){
    const names = row.winners.map(w=>`${escapeHtml(w.nama)} / ${escapeHtml(w.npk)} / ${escapeHtml(w.dept||'')}`).join('<br>');
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${fmtTime(row.ts)}</td><td>${escapeHtml(row.prize)}</td><td>${row.qty}</td><td>${names}</td>`;
    tbody.appendChild(tr);
  }
}

function refreshStats(){
  const unik = new Set(state.participants.map(p=>p.npk)).size;
  const totalHadiah = state.prizes.reduce((a,b)=>a+b.qty,0);
  const sisa = state.prizes.reduce((a,b)=>a+b.remain,0);
  const unwon = state.participants.filter(p=>!p.won).length;
  document.getElementById('statPeserta').textContent = unik;
  document.getElementById('statHadiah').textContent = totalHadiah;
  document.getElementById('statHadiahSisa').textContent = sisa;
  document.getElementById('statUnwon').textContent = unwon;
  document.getElementById('btnSpin').disabled = !(sisa>0 && unwon>0);
}

function setControlsDisabled(dis){
  document.getElementById('btnSpin').disabled = dis || !(state.prizes.some(p=>p.remain>0) && state.participants.some(p=>!p.won));
  document.getElementById('btnUndo').disabled = dis || !undoBuffer;
  document.getElementById('speed').disabled = dis;
}

function escapeHtml(s){ return (s??'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

/**
 * =============================
 *  UNDO (1 tingkat)
 * =============================
 */
function undo(){
  if(!undoBuffer) return; state = JSON.parse(undoBuffer); undoBuffer=null; document.getElementById('btnUndo').disabled=true; saveState();
  refreshStats(); drawWheel(); renderHistory();
}

/**
 * =============================
 *  INIT + EVENT WIRING
 * =============================
 */
function applyTheme(){ document.documentElement.setAttribute('data-bs-theme', state.theme==='dark' ? 'dark' : 'light'); }

function init(){
  // theme & toggles
  state.theme = state.theme||'light'; applyTheme();
  document.getElementById('toggleTheme').checked = state.theme==='dark';
  document.getElementById('toggleTheme').addEventListener('change', e=>{
    state.theme = e.target.checked? 'dark':'light'; applyTheme(); saveState(); drawWheel();
  });
  document.getElementById('toggleSound').checked = !!state.sound;
  document.getElementById('toggleSound').addEventListener('change', e=>{ state.sound = e.target.checked; saveState(); });
  document.getElementById('toggleConfetti').checked = !!state.confetti;
  document.getElementById('toggleConfetti').addEventListener('change', e=>{ state.confetti = e.target.checked; saveState(); });

  // buttons
  document.getElementById('btnSpin').addEventListener('click', spin);
  document.getElementById('btnUndo').addEventListener('click', undo);
  document.getElementById('btnExportWinners').addEventListener('click', exportWinners);
  document.getElementById('btnDownloadPesertaSample').addEventListener('click', ()=>downloadSample('peserta'));
  document.getElementById('btnDownloadHadiahSample').addEventListener('click', ()=>downloadSample('hadiah'));
  document.getElementById('btnClearPeserta').addEventListener('click', ()=>{ if(confirm('Hapus semua peserta?')){ resetParticipants(); }});
  document.getElementById('btnClearHadiah').addEventListener('click', ()=>{ if(confirm('Hapus semua hadiah?')){ resetPrizes(); drawWheel(); }});

  // file inputs
  document.getElementById('filePeserta').addEventListener('change', async e=>{
    const f = e.target.files[0]; if(!f) return;
    const raw = await parseFile(f, 'peserta');
    const list = parseParticipantsFromAny(raw);
    state.participants = dedupeParticipants(list);
    saveState(); refreshStats();
  });
  document.getElementById('fileHadiah').addEventListener('change', async e=>{
    const f = e.target.files[0]; if(!f) return;
    const raw = await parseFile(f, 'hadiah');
    const list = parsePrizesFromAny(raw);
    state.prizes = normalizePrizes(list);
    saveState(); refreshStats(); drawWheel();
  });

  // paste quick
  document.getElementById('btnParsePeserta').addEventListener('click', ()=>{
    const text = document.getElementById('pastePeserta').value.trim(); if(!text) return;
    const lines = text.split(/\r?\n/).filter(Boolean);
    const arr = lines.map(l=>l.split(',').map(c=>c.trim()));
    const list = parseParticipantsFromAny(arr);
    state.participants = dedupeParticipants(list);
    saveState(); refreshStats();
  });
  document.getElementById('btnParseHadiah').addEventListener('click', ()=>{
    const text = document.getElementById('pasteHadiah').value.trim(); if(!text) return;
    const lines = text.split(/\r?\n/).filter(Boolean);
    const arr = lines.map(l=>l.split(',').map(c=>c.trim()));
    const list = parsePrizesFromAny(arr);
    state.prizes = normalizePrizes(list);
    saveState(); refreshStats(); drawWheel();
  });

  // winners modal save
  document.getElementById('btnSaveContinue').addEventListener('click', ()=>{
    if(!pendingResult){ bootstrap.Modal.getOrCreateInstance('#winnerModal').hide(); return; }
    pushHistory(pendingResult); pendingResult=null; bootstrap.Modal.getOrCreateInstance('#winnerModal').hide();
    spinning=false; setControlsDisabled(false);
  });

  // Restore & initial draw
  refreshStats(); renderHistory(); drawWheel(); setControlsDisabled(false);
}

// Kickoff
window.addEventListener('load', init);

/** HOOKS (untuk backend kelak) */
// window.onWinnersCommitted = function(result){ /* panggil API */ }

</script>
</body>
</html>
