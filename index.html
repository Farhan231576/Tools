<!DOCTYPE html>
<html lang="id" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Undian Spin Wheel</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{
      --brand: #4f46e5; /* indigo */
      --bg-soft: #f8fafc;
      --card-radius: 16px;
    }
    body{background: var(--bg-soft);}    
    .app{max-width: 1200px; margin: 24px auto;}
    .card{border: 1px solid rgba(0,0,0,.06); border-radius: var(--card-radius);} 
    .card .card-header{border-bottom: 1px solid rgba(0,0,0,.06)}
    .btn-brand{background: var(--brand); border-color: var(--brand);} 
    .btn-brand:hover{filter: brightness(.95)}

    /* Wheel layout */
    .wheel-wrap{ position: relative; width: 520px; max-width: 100%; aspect-ratio: 1/1; margin-inline: auto; }
    canvas#wheel{ width: 100%; height: 100%; display: block; }
    /* Top pointer (panah) fixed di atas lingkaran */
    .pointer{ position: absolute; top: -8px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 18px solid transparent; border-right: 18px solid transparent; border-top: 0; border-bottom: 28px solid var(--brand); filter: drop-shadow(0 2px 4px rgba(0,0,0,.25)); }
    /* Panah kecil di tengah bulatan (permintaan khusus) */
    .center-arrow{ position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%); width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-top: 14px solid var(--brand); }
    .wheel-btns{ display:flex; gap: 10px; justify-content:center; flex-wrap: wrap; }

    /* Winner overlay */
    .winner-overlay{ position: fixed; inset: 0; background: rgba(0,0,0,.45); backdrop-filter: blur(2px); display:none; align-items:center; justify-content:center; z-index: 50; }
    .winner-card{ background: var(--bs-body-bg); color: var(--bs-body-color); border-radius: 18px; box-shadow: 0 16px 48px rgba(0,0,0,.3); padding: 22px; width: min(720px, 92vw); max-height: 80vh; overflow:auto; border:1px solid rgba(255,255,255,.1)}
    .winner-title{ font-weight: 800; letter-spacing:.2px; }

    /* Confetti canvas */
    #confetti{ position: fixed; inset: 0; pointer-events: none; z-index: 60; display:none; }

    /* Controls tidy */
    .grid{ display:grid; gap: 16px; }
    @media(min-width: 992px){
      .grid-cols{ grid-template-columns: 380px 1fr; }
    }
    textarea.form-control{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:.9rem; }

    .badge-dot{ display:inline-flex; align-items:center; gap:6px; }
    .dot{ width:10px; height:10px; border-radius:50%; display:inline-block; }
  </style>
</head>
<body>
  <div class="app">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h1 class="h4 m-0">ðŸŽ¯ Undian Spin Wheel</h1>
      <div class="d-flex align-items-center gap-2">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" role="switch" id="modeSwitch">
          <label class="form-check-label" for="modeSwitch">Light / Dark</label>
        </div>
        <button class="btn btn-sm btn-outline-secondary" id="btnSample">Isi Contoh</button>
      </div>
    </div>

    <div class="grid grid-cols">
      <!-- Controls -->
      <div class="card">
        <div class="card-header py-2"><strong>ðŸ“‹ Data & Pengaturan</strong></div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label">Peserta (Excel <em>atau</em> Tempel Teks)</label>
            <div class="d-flex gap-2 flex-wrap mb-2">
              <input type="file" id="filePeserta" accept=".xlsx,.xls" class="form-control" style="max-width:280px">
              <button class="btn btn-outline-primary btn-sm" id="downloadTemplate">Unduh Template Excel</button>
            </div>
            <textarea class="form-control" id="taPeserta" rows="6" placeholder="NPK, Nama, Department\n1001, Andi, Finance\n1002, Budi, Sales"></textarea>
            <div class="form-text">Kolom wajib: <b>NPK, Nama, Department</b>. Pakai koma sebagai pemisah kolom.</div>
          </div>

          <div class="mb-3">
            <label class="form-label">Hadiah</label>
            <div class="d-flex gap-2 flex-wrap mb-2">
              <input type="file" id="fileHadiah" accept=".xlsx,.xls" class="form-control" style="max-width:280px">
              <button class="btn btn-outline-primary btn-sm" id="downloadTemplateHadiah">Unduh Template Hadiah</button>
            </div>
            <textarea class="form-control" id="taHadiah" rows="5" placeholder="Nama Hadiah | Jumlah
Motor | 1
Kulkas | 1
Rumah | 2
TV | 5
Lemari | 1"></textarea>
            <div class="form-text">Isi lewat Excel <em>atau</em> tempel teks. Format baris: <b>Nama Hadiah | Jumlah</b>. Pada roda hanya tampil nama unik agar tidak penuh. Pengacakan mempertimbangkan jumlah tersisa.</div>
          </div>

          <div class="mb-3">
            <label for="speed" class="form-label">Kecepatan Putar</label>
            <input type="range" class="form-range" min="1" max="10" value="7" id="speed">
            <div class="small text-muted">Semakin tinggi semakin cepat & momentum lebih panjang.</div>
          </div>

          <div class="d-grid gap-2">
            <button class="btn btn-brand" id="applyData">Terapkan Data</button>
            <button class="btn btn-outline-secondary" id="resetAll">Reset Semua</button>
          </div>

          <hr>
          <div>
            <div class="mb-2"><strong>Status:</strong></div>
            <div id="status" class="small">Belum ada data.</div>
          </div>
        </div>
      </div>

      <!-- Wheel + Winners -->
      <div class="card">
        <div class="card-header py-2 d-flex align-items-center justify-content-between">
          <strong>ðŸ›ž Roda Undian</strong>
          <div class="small" id="legend"></div>
        </div>
        <div class="card-body">
          <div class="wheel-wrap mb-3">
            <div class="pointer"></div>
            <canvas id="wheel" width="1000" height="1000"></canvas>
            <div class="center-arrow"></div>
          </div>
          <div class="wheel-btns mb-3">
            <button class="btn btn-success" id="btnSpin">SPIN</button>
            <button class="btn btn-outline-primary" id="btnExport">Export Pemenang (Excel)</button>
          </div>
          <div class="table-responsive">
            <table class="table table-sm align-middle" id="tblWinners">
              <thead>
                <tr><th>#</th><th>Hadiah</th><th>NPK</th><th>Nama</th><th>Department</th><th>Waktu</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Winner Overlay -->
  <div class="winner-overlay" id="winnerOverlay">
    <div class="winner-card">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="winner-title h4 m-0">ðŸŽ‰ Selamat kepada pemenang!</div>
        <button class="btn btn-sm btn-outline-secondary" id="closeOverlay">Tutup</button>
      </div>
      <div id="winnerList"></div>
    </div>
  </div>
  <canvas id="confetti"></canvas>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
  // ======== Theme Toggle ========
  const modeSwitch = document.getElementById('modeSwitch');
  const rootHTML = document.documentElement;
  modeSwitch.addEventListener('change', () => {
    const theme = modeSwitch.checked ? 'dark' : 'light';
    document.documentElement.setAttribute('data-bs-theme', theme);
  });

  // ======== State ========
  let participants = []; // {npk, nama, dept, won?:bool}
  let prizes = [];       // [{name, qty}]
  let prizeMap = new Map(); // name-> {qty}
  let colorMap = new Map(); // name->color
  let winners = [];      // rows for table

  const wheel = document.getElementById('wheel');
  const ctx = wheel.getContext('2d');
  const statusEl = document.getElementById('status');
  const legendEl = document.getElementById('legend');

  // ======== Helpers ========
  function parseParticipantsText(text){
    const rows = text.split(/\r?\n/).map(r=>r.trim()).filter(Boolean);
    const out = [];
    for(const r of rows){
      const cols = r.split(',').map(c=>c.trim());
      if(cols.length >= 3){
        out.push({npk: cols[0], nama: cols[1], dept: cols[2], won:false});
      }
    }
    return out;
  }
  function parsePrizesText(text){
    const rows = text.split(/\r?\n/).map(r=>r.trim()).filter(Boolean);
    const out = [];
    for(const r of rows){
      const [name, qtyStr] = r.split('|').map(x=>x?.trim());
      if(name && qtyStr){
        const qty = Math.max(0, parseInt(qtyStr,10)||0);
        if(qty>0) out.push({name, qty});
      }
    }
    return out;
  }
  function seedColorFor(str){
    // stable color per prize using hash -> HSL palette
    let h=0; for(let i=0;i<str.length;i++){ h = (h*31 + str.charCodeAt(i))>>>0; }
    const hue = h % 360;
    return `hsl(${hue}, 70%, 55%)`;
  }
  function buildMaps(){
    prizeMap.clear(); colorMap.clear();
    for(const p of prizes){
      prizeMap.set(p.name, {qty:p.qty});
      if(!colorMap.has(p.name)) colorMap.set(p.name, seedColorFor(p.name));
    }
  }
  function distinctPrizeNames(){
    return [...new Set(prizes.map(p=>p.name))];
  }
  function totalRemainingUnits(){
    let t=0; for(const [n, obj] of prizeMap){ t += obj.qty; } return t;
  }
  function remainingPrizeEntries(){
    return [...prizeMap].filter(([_,v])=>v.qty>0);
  }

  // ======== Wheel Drawing (Canvas) ========
  let rotation = 0; // radians
  function drawWheel(){
    const names = distinctPrizeNames();
    const N = names.length || 1;
    const cx = wheel.width/2, cy = wheel.height/2; const r = wheel.width/2 - 10;
    ctx.clearRect(0,0,wheel.width,wheel.height);

    const arc = 2*Math.PI / N;
    for(let i=0;i<N;i++){
      const name = names[i];
      const color = colorMap.get(name) || '#999';
      const start = rotation + i*arc;
      const end = start + arc;
      // slice
      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.arc(cx,cy,r,start,end);
      ctx.closePath();
      ctx.fillStyle = color; ctx.fill();
      ctx.strokeStyle = 'rgba(255,255,255,.9)'; ctx.lineWidth = 4; ctx.stroke();

      // label
      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(start + arc/2);
      ctx.textAlign = 'right';
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 34px system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans';
      ctx.fillText(name, r-20, 10);
      ctx.restore();
    }

    // center circle
    ctx.beginPath();
    ctx.arc(cx,cy,70,0,2*Math.PI);
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--bs-body-bg') || '#fff';
    ctx.fill();
    ctx.lineWidth = 3; ctx.strokeStyle = 'rgba(0,0,0,.15)'; ctx.stroke();

    // center text
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--bs-body-color') || '#000';
    ctx.font = '600 18px system-ui';
    ctx.textAlign = 'center';
    ctx.fillText('SPIN', cx, cy+6);
  }

  // Legend
  function renderLegend(){
    legendEl.innerHTML = distinctPrizeNames().map(n=>{
      const c = colorMap.get(n)||'#999';
      return `<span class="badge-dot me-2"><span class="dot" style="background:${c}"></span>${n} <small class="text-muted">(sisa ${prizeMap.get(n)?.qty||0})</small></span>`;
    }).join('');
  }

  // ======== Spin Logic ========
  let spinning=false, animId=null; 
  let targetPrizeName=null, targetAngle=null; 
  function choosePrizeWeighted(){
    const entries = remainingPrizeEntries();
    const total = entries.reduce((a,[,v])=>a+v.qty,0);
    let rnd = Math.random()*total;
    for(const [name, v] of entries){
      if(rnd < v.qty) return name; rnd -= v.qty;
    }
    return entries[0]?.[0] || null;
  }
  function computeTargetAngleForPrize(name){
    const names = distinctPrizeNames();
    const idx = names.indexOf(name); if(idx<0) return rotation; 
    const arc = 2*Math.PI / names.length;
    const sliceCenter = idx*arc + arc/2;
    // pointer is at angle -Math.PI/2 (top). We want rotation so that sliceCenter aligns to that.
    // We rotate canvas, so visible pointer fixed at top; need target rotation so (sliceCenter + rotation) aligns to -PI/2
    const desired = -Math.PI/2 - (sliceCenter);
    return desired;
  }
  function spin(){
    if(spinning) return; 
    if(totalRemainingUnits()===0){ alert('Semua hadiah sudah habis.'); return; }
    const available = participants.filter(p=>!p.won);
    if(available.length===0){ alert('Semua peserta sudah menang.'); return; }

    const prizeName = choosePrizeWeighted();
    targetPrizeName = prizeName;
    targetAngle = computeTargetAngleForPrize(prizeName);

    const speedVal = +document.getElementById('speed').value; // 1..10
    const spinTime = 2000 + speedVal*250; // duration accelerate
    const extraRot = (4 + Math.floor(speedVal/2)) * 2*Math.PI; // extra turns

    const start = performance.now();
    const startRot = rotation;
    const deltaToTarget = normalizeAngle(targetAngle - startRot);

    const endRot = startRot + extraRot + deltaToTarget; // overspin + land exactly

    spinning = true;
    function easeOutCubic(t){return 1 - Math.pow(1 - t, 3);}
    function frame(ts){
      const t = Math.min(1, (ts - start)/(spinTime + speedVal*500));
      const eased = easeOutCubic(t);
      rotation = startRot + (endRot - startRot)*eased;
      drawWheel();
      if(t < 1){ animId = requestAnimationFrame(frame); }
      else { spinning=false; onSpinEnd(); }
    }
    animId = requestAnimationFrame(frame);
  }
  function normalizeAngle(a){
    while(a>Math.PI) a-=2*Math.PI; while(a<-Math.PI) a+=2*Math.PI; return a;
  }

  function onSpinEnd(){
    if(!targetPrizeName) return;
    const remainQty = prizeMap.get(targetPrizeName)?.qty || 0;
    if(remainQty<=0){ renderLegend(); return; }

    // Number of winners = remaining qty of the selected prize, bounded by available participants
    const available = participants.filter(p=>!p.won);
    const k = Math.min(remainQty, available.length);
    const selected = pickK(available, k);

    // Mark winners and reduce prize qty to 0 (given per requirement: berhenti di TV 7x -> keluar 7 nama langsung)
    for(const w of selected){ w.won = true; }
    prizeMap.get(targetPrizeName).qty -= k; // potentially 0

    // Add to table & overlay
    pushWinners(targetPrizeName, selected);
    renderLegend();
    launchConfetti();
    showOverlay(targetPrizeName, selected);

    // If all prizes done -> notify
    if(totalRemainingUnits()===0){ setStatus('ðŸŽ Semua hadiah telah dibagikan.'); }
    else setStatus(`Hadiah "${targetPrizeName}" dibagikan sebanyak ${k}. Sisa total hadiah: ${totalRemainingUnits()}.`);
  }
  function pickK(arr, k){
    const copy = arr.slice();
    for(let i=copy.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [copy[i],copy[j]]=[copy[j],copy[i]]; }
    return copy.slice(0,k);
  }

  // ======== Winners Table & Overlay ========
  const winnersTbody = document.querySelector('#tblWinners tbody');
  function pushWinners(prizeName, persons){
    const now = new Date();
    for(const p of persons){
      winners.push({prize: prizeName, ...p, time: now.toLocaleString()});
    }
    rebuildWinnersTable();
  }
  function rebuildWinnersTable(){
    winnersTbody.innerHTML = winners.map((w, i)=>`
      <tr>
        <td>${i+1}</td>
        <td>${escapeHtml(w.prize)}</td>
        <td>${escapeHtml(w.npk)}</td>
        <td>${escapeHtml(w.nama)}</td>
        <td>${escapeHtml(w.dept)}</td>
        <td>${escapeHtml(w.time)}</td>
      </tr>`).join('');
  }
  function showOverlay(prizeName, persons){
    const overlay = document.getElementById('winnerOverlay');
    const list = document.getElementById('winnerList');
    list.innerHTML = `
      <div class="mb-2"><span class="badge bg-success">${escapeHtml(prizeName)}</span> Ã— ${persons.length}</div>
      <div class="table-responsive"><table class="table table-sm">
        <thead><tr><th>#</th><th>NPK</th><th>Nama</th><th>Department</th></tr></thead>
        <tbody>${persons.map((p,i)=>`<tr><td>${i+1}</td><td>${escapeHtml(p.npk)}</td><td>${escapeHtml(p.nama)}</td><td>${escapeHtml(p.dept)}</td></tr>`).join('')}</tbody>
      </table></div>`;
    overlay.style.display = 'flex';
  }
  document.getElementById('closeOverlay').onclick = ()=>{
    document.getElementById('winnerOverlay').style.display = 'none';
  };

  // ======== Confetti ========
  const confettiCanvas = document.getElementById('confetti');
  const cctx = confettiCanvas.getContext('2d');
  function launchConfetti(){
    confettiCanvas.width = innerWidth; confettiCanvas.height = innerHeight; confettiCanvas.style.display='block';
    const pieces = Array.from({length: 180}, ()=>({
      x: Math.random()*innerWidth,
      y: -20 - Math.random()*innerHeight*0.4,
      w: 6 + Math.random()*6,
      h: 10 + Math.random()*12,
      rot: Math.random()*Math.PI,
      velY: 2 + Math.random()*4,
      velX: -2 + Math.random()*4,
      color: `hsl(${Math.floor(Math.random()*360)}, 90%, 60%)`
    }));
    const start = performance.now();
    function frame(ts){
      const t = (ts-start)/1000;
      cctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
      for(const p of pieces){
        p.x += p.velX; p.y += p.velY; p.rot += 0.08;
        cctx.save(); cctx.translate(p.x, p.y); cctx.rotate(p.rot);
        cctx.fillStyle = p.color; cctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
        cctx.restore();
      }
      if(t < 3){ requestAnimationFrame(frame); }
      else { confettiCanvas.style.display='none'; }
    }
    requestAnimationFrame(frame);
  }

  // ======== Excel Import/Export ========
  document.getElementById('filePeserta').addEventListener('change', (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = (ev)=>{
      const wb = XLSX.read(new Uint8Array(ev.target.result), {type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const data = XLSX.utils.sheet_to_json(ws, {defval:''});
      const rows = data.map(r=>`${r.NPK||r.npk||''}, ${r.Nama||r.nama||''}, ${r.Department||r.Dept||r.department||''}`)
                       .filter(s=>s.replace(/[,:\s]/g,'').length>0);
      document.getElementById('taPeserta').value = rows.join('
');
      setStatus(`Terbaca ${rows.length} baris peserta dari Excel.`);
    };
    reader.readAsArrayBuffer(file);
  });
  // Import Excel Hadiah
  document.getElementById('fileHadiah').addEventListener('change', (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = (ev)=>{
      const wb = XLSX.read(new Uint8Array(ev.target.result), {type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const data = XLSX.utils.sheet_to_json(ws, {defval:''});
      const rows = data.map(r=>{
        const name = r.Hadiah || r.Nama || r.Prize || r.hadiah || r.nama || r.prize || '';
        const qty  = r.Jumlah || r.Qty || r.Quantity || r.jumlah || r.qty || r.quantity || '';
        const qn = parseInt(qty,10);
        if(name && !isNaN(qn) && qn>0) return `${name} | ${qn}`; else return '';
      }).filter(Boolean);
      document.getElementById('taHadiah').value = rows.join('
');
      setStatus(`Terbaca ${rows.length} baris hadiah dari Excel.`);
    };
    reader.readAsArrayBuffer(file);
  });
    reader.onload = (ev)=>{
      const wb = XLSX.read(new Uint8Array(ev.target.result), {type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const data = XLSX.utils.sheet_to_json(ws, {defval:''});
      const rows = data.map(r=>`${r.NPK||r.npk||''}, ${r.Nama||r.nama||''}, ${r.Department||r.Dept||r.department||''}`)
                       .filter(s=>s.replace(/[,\s]/g,'').length>0);
      document.getElementById('taPeserta').value = rows.join('\n');
      setStatus(`Terbaca ${rows.length} baris dari Excel.`);
    };
    reader.readAsArrayBuffer(file);
  });
  document.getElementById('btnExport').addEventListener('click', ()=>{
    if(!winners.length){ alert('Belum ada pemenang.'); return; }
    const ws = XLSX.utils.json_to_sheet(winners.map((w,i)=>({
      No: i+1,
      Hadiah: w.prize,
      NPK: w.npk,
      Nama: w.nama,
      Department: w.dept,
      Waktu: w.time
    })));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Pemenang');

    // Sheet 2: Sisa Hadiah
    const remain = [...prizeMap].map(([name,obj])=>({Hadiah:name, Sisa: obj.qty}));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(remain), 'Sisa Hadiah');

    // Sheet 3: Sisa Peserta
    const remainingPeople = participants.filter(p=>!p.won);
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(remainingPeople.map(p=>({NPK:p.npk,Nama:p.nama,Department:p.dept}))), 'Sisa Peserta');

    XLSX.writeFile(wb, 'hasil-undian.xlsx');
  });
  document.getElementById('downloadTemplate').addEventListener('click', ()=>{
    const ws = XLSX.utils.aoa_to_sheet([["NPK","Nama","Department"],["1001","Andi","Finance"],["1002","Budi","Sales"]]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Peserta Template');
    XLSX.writeFile(wb, 'template-peserta.xlsx');
  });
  document.getElementById('downloadTemplateHadiah').addEventListener('click', ()=>{
    const ws = XLSX.utils.aoa_to_sheet([["Hadiah","Jumlah"],["Motor",1],["Kulkas",1],["Rumah",2],["TV",5],["Lemari",1]]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Hadiah Template');
    XLSX.writeFile(wb, 'template-hadiah.xlsx');
  });
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Peserta Template');
    XLSX.writeFile(wb, 'template-peserta.xlsx');
  });

  // ======== Apply / Reset / Samples ========
  document.getElementById('applyData').addEventListener('click', ()=>{
    const pText = document.getElementById('taPeserta').value;
    const hText = document.getElementById('taHadiah').value;
    const p = parseParticipantsText(pText);
    const h = parsePrizesText(hText);
    if(!p.length || !h.length){
      alert('Mohon isi Peserta dan Hadiah dengan benar.'); return;
    }
    participants = p; prizes = h; buildMaps();
    drawWheel(); renderLegend();
    setStatus(`Peserta: ${participants.length} | Total unit hadiah: ${totalRemainingUnits()} | Jenis hadiah: ${distinctPrizeNames().length}`);
  });
  document.getElementById('resetAll').addEventListener('click', ()=>{
    if(spinning) return;
    participants = participants.map(p=>({...p, won:false}));
    prizes = prizes.map(p=>({...p})); buildMaps(); winners=[]; rebuildWinnersTable();
    drawWheel(); renderLegend(); setStatus('Sudah di-reset.');
  });
  document.getElementById('btnSample').addEventListener('click', ()=>{
    document.getElementById('taPeserta').value = `NPK, Nama, Department\n1001, Andi, Finance\n1002, Budi, Sales\n1003, Citra, HR\n1004, Dedi, IT\n1005, Evi, Marketing\n1006, Fajar, GA\n1007, Gita, QA\n1008, Hasan, Legal\n1009, Intan, RnD\n1010, Joko, Purchasing`;
    document.getElementById('taHadiah').value = `Motor | 1\nKulkas | 1\nRumah | 2\nTV | 5\nLemari | 1`;
  });

  // ======== Spin Button ========
  document.getElementById('btnSpin').addEventListener('click', spin);

  // ======== Utilities ========
  function setStatus(msg){ statusEl.textContent = msg; }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

  // Init default wheel visuals
  // Preload some default colors & wheel so user sees UI
  prizes = [{name:'Motor',qty:1},{name:'Kulkas',qty:1},{name:'Rumah',qty:2},{name:'TV',qty:5},{name:'Lemari',qty:1}];
  buildMaps(); drawWheel(); renderLegend();

  </script>
</body>
</html>
