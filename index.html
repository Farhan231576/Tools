<!doctype html>
<html lang="id" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Undian Spin Wheel</title>
  <!-- Bootstrap 5.3 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root { --accent: #6f6cfb; --accent-2:#22c55e; }
    body { background: var(--bs-body-bg); }
    .app-title { letter-spacing:.3px; }
    .wheel-wrap { position:relative; display:grid; place-items:center; }
    canvas#wheel { width: 420px; height: 420px; max-width: 80vw; max-height: 80vw; }
    .center-pin {
      position:absolute; inset:0; display:grid; place-items:center; pointer-events:none;
    }
    .center-pin .arrow {
      width: 0; height: 0; border-left: 12px solid transparent; border-right: 12px solid transparent;
      border-bottom: 26px solid var(--accent); filter: drop-shadow(0 2px 3px rgba(0,0,0,.25));
      transform: translateY(-6px);
    }
    .center-pin .hub { width:46px; height:46px; border-radius:50%; background:#fff; border:4px solid var(--accent);
      position:absolute; display:grid; place-items:center; font-weight:800; font-size:.8rem; color:var(--accent) }
    .wheel-shadow { filter: drop-shadow(0 8px 22px rgba(0,0,0,.2)); }
    .controls .form-label small { opacity:.8 }
    .badge-qty { font-variant-numeric: tabular-nums; }
    .winner-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,.55);
      display: none; align-items: center; justify-content: center; z-index: 1100;
    }
    .winner-card { max-width: 640px; }
    .legend-swatch { width: .9rem; height: .9rem; display:inline-block; border-radius:3px; margin-right:.4rem; border:1px solid rgba(0,0,0,.15)}
    .btn-accent { background: var(--accent); color:#fff; border:0 }
    .btn-accent:hover { filter: brightness(0.95) }
    .spin-btn { font-weight:700; text-transform:uppercase; letter-spacing:.6px }
    .list-group-item small { opacity:.8 }
  </style>
</head>
<body>
  <div class="container py-4 py-md-5">
    <div class="d-flex align-items-center justify-content-between mb-4">
      <h1 class="h3 app-title mb-0">ðŸŽ¯ Undian Spin Wheel</h1>
      <div class="d-flex align-items-center gap-2">
        <button id="toggleTheme" class="btn btn-outline-secondary btn-sm" type="button" title="Light/Dark">
          <span class="d-none d-sm-inline">Mode</span> <span class="ms-1" id="themeIcon">ðŸŒ™</span>
        </button>
      </div>
    </div>

    <div class="row g-4">
      <!-- Left: Inputs -->
      <div class="col-lg-4">
        <div class="card shadow-sm">
          <div class="card-body controls">
            <h5 class="card-title">Data Peserta</h5>
            <p class="text-secondary small mb-2">Tempel (copyâ€“paste) satu nama per baris.</p>
            <textarea id="taPeserta" class="form-control mb-3" rows="6" placeholder="cth:
Andi
Budi
Clara
â€¦"></textarea>

            <h5 class="card-title mt-3">Data Hadiah</h5>
            <p class="text-secondary small mb-2">Satu baris per hadiah. Bisa pakai format "Nama xQty" atau "Nama,Qty". Contoh di bawah.</p>
            <textarea id="taHadiah" class="form-control" rows="6" placeholder="cth:
Motor x1
Kulkas x1
Rumah x2
TV x5
Lemari x1"></textarea>

            <div class="d-grid gap-2 mt-3">
              <button class="btn btn-accent" id="btnLoad">Muat Daftar</button>
              <button class="btn btn-outline-danger" id="btnReset">Reset</button>
            </div>

            <hr class="my-4">

            <label class="form-label">Peserta yang diundi <small>(otomatis hilang setelah menang)</small></label>
            <div class="input-group mb-3">
              <select id="selPeserta" class="form-select"></select>
              <button class="btn btn-outline-secondary" id="btnRandPeserta" type="button">Acak</button>
            </div>

            <div class="row g-3">
              <div class="col-6">
                <label for="speed" class="form-label">Kecepatan <small>(deg/s)</small></label>
                <input type="range" class="form-range" id="speed" min="500" max="2000" step="50" value="1200">
              </div>
              <div class="col-6">
                <label for="duration" class="form-label">Durasi <small>(detik)</small></label>
                <input type="range" class="form-range" id="duration" min="3" max="8" step="0.5" value="5">
              </div>
            </div>

            <div class="d-grid mt-3">
              <button class="btn btn-accent spin-btn" id="btnSpin">SPIN</button>
            </div>
          </div>
        </div>

        <div class="card shadow-sm mt-4">
          <div class="card-body">
            <h5 class="card-title mb-3">Legenda Hadiah</h5>
            <ul id="legend" class="list-group list-group-flush"></ul>
          </div>
        </div>

      </div>

      <!-- Right: Wheel & Winners -->
      <div class="col-lg-8">
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <h5 class="card-title mb-0">Roda Undian</h5>
              <span class="badge text-bg-secondary" id="statusBadge">Siap</span>
            </div>
            <div class="wheel-wrap">
              <canvas id="wheel" width="720" height="720" class="wheel-shadow" aria-label="Spin wheel"></canvas>
              <div class="center-pin" aria-hidden="true">
                <div class="hub">â†‘</div>
                <div class="arrow"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="row g-4">
          <div class="col-md-6">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <h5 class="card-title mb-3">Riwayat Pemenang</h5>
                <ul id="winners" class="list-group list-group-flush"></ul>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <h5 class="card-title mb-3">Sisa Kuota Hadiah</h5>
                <ul id="quota" class="list-group list-group-flush"></ul>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Winner Overlay -->
  <div class="winner-overlay" id="winnerOverlay">
    <div class="card winner-card text-center">
      <div class="card-body p-4 p-md-5">
        <div class="display-6 mb-2">ðŸŽ‰ SELAMAT! ðŸŽ‰</div>
        <div class="fs-4">Pemenang:</div>
        <div class="fw-bold h2 my-2" id="ovName">â€”</div>
        <div class="fs-5">Hadiah:</div>
        <div class="fw-bold h3 my-2" id="ovPrize">â€”</div>
        <button class="btn btn-accent mt-3" id="btnCloseOverlay">Tutup</button>
      </div>
    </div>
  </div>

  <!-- Bootstrap & libs -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.0/dist/confetti.browser.min.js"></script>
  <script>
    // ======== State ========
    const palette = [
      '#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#a855f7', '#f97316', '#14b8a6', '#22c55e', '#eab308', '#06b6d4',
      '#fb7185', '#60a5fa', '#34d399', '#f472b6', '#a3e635', '#93c5fd', '#facc15', '#84cc16', '#f43f5e', '#6366f1'
    ];

    let prizes = []; // [{name, qty}]
    let remaining = []; // deep copy of prizes with remaining qty
    let participants = []; // unique names
    let remainingParticipants = [];
    let colorMap = {}; // name -> color

    // Wheel state
    const canvas = document.getElementById('wheel');
    const ctx = canvas.getContext('2d');
    let angle = 0; // current rotation in radians
    let spinning = false;

    // ======== Helpers ========
    const hash = (s) => s.split('').reduce((a,c)=>((a<<5)-a + c.charCodeAt(0))|0,0) >>> 0;
    function colorFor(name){
      if(colorMap[name]) return colorMap[name];
      const h = hash(name);
      const col = palette[h % palette.length];
      return colorMap[name] = col;
    }

    function parseParticipants(text){
      return [...new Set(text.split(/\n|,|;|\t/g).map(s=>s.trim()).filter(Boolean))];
    }

    function parsePrizes(text){
      const lines = text.split(/\n+/).map(l=>l.trim()).filter(Boolean);
      const acc = {};
      for(const line of lines){
        // accept: "Nama x2" or "Nama,2" or "Nama 2"
        const m1 = line.match(/^(.+?)[\s,]*x?\s*(\d+)$/i);
        const name = m1 ? m1[1].trim() : line;
        const qty = m1 ? Math.max(1, parseInt(m1[2],10)) : 1;
        acc[name] = (acc[name]||0) + qty;
      }
      return Object.entries(acc).map(([name, qty])=>({name, qty}));
    }

    function totalQty(){ return remaining.reduce((t,p)=>t+p.qty,0); }

    function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }

    function rad(deg){ return deg * Math.PI / 180; }

    function drawWheel(){
      const w = canvas.width, h = canvas.height; const r = Math.min(w,h)/2 - 10;
      ctx.clearRect(0,0,w,h);
      ctx.save();
      ctx.translate(w/2, h/2);
      ctx.rotate(angle);

      const total = Math.max(1, totalQty());
      let start = -Math.PI/2; // start from top

      for(const p of remaining){
        const frac = p.qty / total; // proportional to remaining qty
        const arc = frac * Math.PI * 2;
        // slice
        ctx.beginPath();
        ctx.moveTo(0,0);
        ctx.arc(0,0,r, start, start+arc);
        ctx.closePath();
        ctx.fillStyle = colorFor(p.name);
        ctx.fill();
        // stroke ring to separate
        ctx.lineWidth = 2;
        ctx.strokeStyle = 'rgba(0,0,0,.15)';
        ctx.stroke();
        // text label (only once)
        ctx.save();
        const mid = start + arc/2;
        ctx.rotate(mid);
        ctx.translate(r*0.68, 0);
        ctx.rotate(Math.PI/2);
        ctx.fillStyle = '#fff';
        ctx.font = '700 24px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        const label = p.name.toUpperCase();
        // text shadow for readability
        ctx.shadowColor = 'rgba(0,0,0,.25)';
        ctx.shadowBlur = 4; ctx.shadowOffsetY = 2;
        ctx.fillText(label, 0, 0, r*0.9);
        ctx.restore();

        p._start = start; p._end = start + arc; // store for hit-test
        start += arc;
      }

      // outer rim
      ctx.beginPath();
      ctx.arc(0,0,r+6,0,Math.PI*2);
      ctx.lineWidth = 12; ctx.strokeStyle = '#fff';
      ctx.stroke();

      ctx.restore();
    }

    function rebuildLegend(){
      const ul = document.getElementById('legend');
      ul.innerHTML = '';
      for(const p of remaining){
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `<span><i class="legend-swatch" style="background:${colorFor(p.name)}"></i>${p.name}</span>`+
          `<span class="badge text-bg-light badge-qty">x${p.qty}</span>`;
        ul.appendChild(li);
      }
    }

    function rebuildQuota(){
      const ul = document.getElementById('quota');
      ul.innerHTML = '';
      for(const p of remaining){
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `<span>${p.name}</span><span class="badge text-bg-secondary">Sisa: ${p.qty}</span>`;
        ul.appendChild(li);
      }
    }

    function rebuildParticipantsSelect(){
      const sel = document.getElementById('selPeserta');
      sel.innerHTML = '';
      for(const n of remainingParticipants){
        const opt = document.createElement('option'); opt.value = n; opt.textContent = n; sel.appendChild(opt);
      }
    }

    function setStatus(t){ document.getElementById('statusBadge').textContent = t; }

    function confettiBurst(){
      const duration = 1600;
      const end = Date.now() + duration;
      (function frame(){
        confetti({ particleCount: 4, spread: 70, origin: { y: 0.6 } });
        if(Date.now() < end) requestAnimationFrame(frame);
      })();
    }

    function pickPrizeWeighted(){
      const total = totalQty(); if(total<=0) return null;
      let r = Math.random() * total;
      for(const p of remaining){
        if(r < p.qty) return p;
        r -= p.qty;
      }
      return remaining.at(-1) || null;
    }

    function findSegmentAngles(prize){
      // Find stored angles (after drawWheel sets _start/_end)
      for(const p of remaining){
        if(p.name === prize.name){ return {start:p._start, end:p._end}; }
      }
      return {start:-Math.PI/2, end:-Math.PI/2};
    }

    function spinToPrize(prize){
      if(spinning) return;
      const speed = parseFloat(document.getElementById('speed').value); // deg/s
      const duration = parseFloat(document.getElementById('duration').value); // s
      const minRot = rad(speed * duration); // total radians to rotate baseline

      const seg = findSegmentAngles(prize);
      // target is arrow up (top), wheel rotates so that segment's mid aligns to top
      const mid = (seg.start + seg.end)/2;
      // we want angle_end such that (current angle + spin) % TAU makes mid end at -PI/2
      const TAU = Math.PI*2;
      let targetAngle = angle + minRot; // baseline spin forward
      // compute delta required to land mid at top: topAngle = -PI/2
      const alignDelta = (-Math.PI/2) - mid;
      targetAngle += alignDelta;
      // add a few extra full turns for flair
      const extraTurns = 2 + Math.floor(Math.random()*2); // 2-3 extra turns
      targetAngle += extraTurns * TAU;

      // animation
      const startTime = performance.now();
      const startAngle = angle;
      const totalDelta = targetAngle - startAngle;
      spinning = true; setStatus('Berputarâ€¦');

      function tick(now){
        const t = Math.min(1, (now - startTime) / (duration*1000));
        const eased = easeOutCubic(t);
        angle = startAngle + totalDelta * eased;
        drawWheel();
        if(t < 1) {
          requestAnimationFrame(tick);
        } else {
          spinning = false; angle = angle % (Math.PI*2);
          setStatus('Selesai');
          onSpinEnd(prize);
        }
      }
      requestAnimationFrame(tick);
    }

    function onSpinEnd(prize){
      // Reveal winner
      const sel = document.getElementById('selPeserta');
      const name = sel.value || remainingParticipants[0];
      if(!name){ alert('Masukkan peserta terlebih dahulu.'); return; }

      // Update quotas and participants
      const p = remaining.find(x=>x.name===prize.name);
      if(p){ p.qty--; if(p.qty<=0){ remaining = remaining.filter(x=>x.qty>0); } }
      remainingParticipants = remainingParticipants.filter(n=>n!==name);

      // UI rebuild
      rebuildLegend();
      rebuildQuota();
      rebuildParticipantsSelect();
      drawWheel();

      // Winners list
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex justify-content-between align-items-center';
      li.innerHTML = `<span><strong>${name}</strong></span><span class="badge text-bg-success">${prize.name}</span>`;
      document.getElementById('winners').prepend(li);

      // Overlay + Confetti
      document.getElementById('ovName').textContent = name;
      document.getElementById('ovPrize').textContent = prize.name;
      document.getElementById('winnerOverlay').style.display = 'flex';
      confettiBurst();

      // Auto-close overlay after a bit (optional)
      setTimeout(()=>{ document.getElementById('winnerOverlay').style.display='none'; }, 4000);

      // If no participants or no prizes left -> disable spin
      if(remainingParticipants.length===0 || totalQty()===0){
        document.getElementById('btnSpin').disabled = true;
        setStatus('Undian selesai');
      }
    }

    // ======== Event wiring ========
    document.getElementById('btnLoad').addEventListener('click', ()=>{
      const ptext = document.getElementById('taPeserta').value.trim();
      const htext = document.getElementById('taHadiah').value.trim();
      participants = parseParticipants(ptext);
      remainingParticipants = participants.slice();
      prizes = parsePrizes(htext);
      remaining = JSON.parse(JSON.stringify(prizes));

      if(remainingParticipants.length===0){
        // quick default if empty, as per example in prompt
        remainingParticipants = ['Peserta 1','Peserta 2','Peserta 3','Peserta 4','Peserta 5','Peserta 6','Peserta 7','Peserta 8','Peserta 9','Peserta 10'];
      }
      if(remaining.length===0){
        remaining = [ {name:'Motor',qty:1},{name:'Kulkas',qty:1},{name:'Rumah',qty:2},{name:'TV',qty:5},{name:'Lemari',qty:1} ];
      }

      rebuildParticipantsSelect();
      rebuildLegend();
      rebuildQuota();
      drawWheel();
      setStatus('Siap');
      document.getElementById('btnSpin').disabled = false;
    });

    document.getElementById('btnReset').addEventListener('click', ()=>{
      participants = []; remainingParticipants = [];
      prizes = []; remaining = [];
      document.getElementById('taPeserta').value = '';
      document.getElementById('taHadiah').value = '';
      document.getElementById('legend').innerHTML = '';
      document.getElementById('quota').innerHTML = '';
      document.getElementById('winners').innerHTML = '';
      document.getElementById('selPeserta').innerHTML = '';
      angle = 0; drawWheel();
      setStatus('Siap');
      document.getElementById('btnSpin').disabled = true;
    });

    document.getElementById('btnRandPeserta').addEventListener('click', ()=>{
      if(remainingParticipants.length===0) return;
      const i = Math.floor(Math.random()*remainingParticipants.length);
      document.getElementById('selPeserta').value = remainingParticipants[i];
    });

    document.getElementById('btnSpin').addEventListener('click', ()=>{
      if(spinning) return;
      if(remainingParticipants.length===0){ alert('Peserta habis.'); return; }
      if(totalQty()===0){ alert('Hadiah habis.'); return; }
      // Weighted pick but wheel slice sizes also reflect qty, so any prize can be targeted to top
      const prize = pickPrizeWeighted();
      // redraw before computing angles to ensure _start/_end are up-to-date
      drawWheel();
      spinToPrize(prize);
    });

    document.getElementById('btnCloseOverlay').addEventListener('click', ()=>{
      document.getElementById('winnerOverlay').style.display = 'none';
    });

    // Theme toggle
    const themeBtn = document.getElementById('toggleTheme');
    themeBtn.addEventListener('click', ()=>{
      const html = document.documentElement;
      const cur = html.getAttribute('data-bs-theme');
      const next = cur === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-bs-theme', next);
      document.getElementById('themeIcon').textContent = next==='dark' ? 'ðŸŒž' : 'ðŸŒ™';
      drawWheel();
    });

    // Initial draw (empty wheel placeholder)
    drawWheel();

    // ======== Prefill example to match prompt ========
    document.getElementById('taPeserta').value = `Andi\nBudi\nCitra\nDewi\nEvan\nFajar\nGita\nHadi\nIntan\nJoko`;
    document.getElementById('taHadiah').value = `Motor x1\nKulkas x1\nRumah x2\nTV x5\nLemari x1`;
  </script>
</body>
</html>
