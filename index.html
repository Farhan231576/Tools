<!DOCTYPE html>
<html lang="id" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Undian Spin Wheel</title>
  <!-- Bootstrap 5.3 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --brand: #6c5ce7;
      --brand-2: #00b894;
      --ring: 420px; /* diameter */
    }
    body { min-height: 100vh; }

    .app-wrap { max-width: 1100px; margin: 24px auto; }

    .wheel-wrap {
      position: relative;
      width: var(--ring);
      height: var(--ring);
      margin-inline: auto;
    }
    canvas#wheel { width: 100%; height: 100%; }

    /* Pointer arrow that sits above the spinning canvas, centered */
    .pointer {
      position: absolute;
      left: 50%; top: 50%;
      transform: translate(-50%, -50%);
      width: 120px; height: 120px;
      pointer-events: none;
      z-index: 5;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,.25));
    }

    .controls-sticky { position: sticky; top: 16px; }

    .winner-badge { font-weight: 700; }

    /* Confetti canvas overlay */
    #confetti {
      position: fixed; inset: 0; pointer-events: none; z-index: 2000;
    }

    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .brand-gradient {
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      -webkit-background-clip: text; background-clip: text; color: transparent;
    }

    .legend-swatch { width: 14px; height: 14px; border-radius: 3px; display: inline-block; margin-right: 8px; vertical-align: middle; }
  </style>
</head>
<body class="bg-body">
  <canvas id="confetti"></canvas>

  <div class="app-wrap container">
    <div class="d-flex flex-wrap align-items-center justify-content-between mb-3 gap-3">
      <h1 class="h3 m-0 brand-gradient">Undian Spin Wheel</h1>
      <div class="d-flex gap-2">
        <button id="toggleTheme" class="btn btn-outline-secondary btn-sm" type="button" title="Light/Dark">
          <span class="theme-label">Dark</span> mode
        </button>
        <button id="resetBtn" class="btn btn-outline-danger btn-sm" type="button">Reset</button>
      </div>
    </div>

    <div class="row g-4">
      <!-- Left: Inputs -->
      <div class="col-lg-5">
        <div class="card controls-sticky">
          <div class="card-body">
            <h5 class="card-title">Peserta</h5>
            <p class="text-body-secondary small">Copy–paste, satu nama per baris.</p>
            <textarea id="participantsInput" class="form-control mono" rows="7"></textarea>

            <hr class="my-4" />

            <h5 class="card-title">Hadiah</h5>
            <p class="text-body-secondary small">Bisa tulis <code>Nama x Jumlah</code> <em>atau</em> tulis berulang per baris.</p>
            <textarea id="prizesInput" class="form-control mono" rows="7"></textarea>

            <div class="d-grid gap-2 mt-3">
              <button id="applyBtn" class="btn btn-primary">Terapkan Data</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Right: Wheel & status -->
      <div class="col-lg-7">
        <div class="card">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div>
                <div class="text-body-secondary small">Giliran</div>
                <div class="h5 m-0" id="currentPlayer">—</div>
              </div>
              <div class="text-end">
                <div class="text-body-secondary small">Sisa Hadiah</div>
                <div class="h5 m-0"><span id="remainingPrizes">0</span></div>
              </div>
            </div>

            <div class="wheel-wrap my-3">
              <canvas id="wheel" width="840" height="840" aria-label="Roda Undian"></canvas>
              <!-- Centered pointer (does not rotate) -->
              <svg class="pointer" viewBox="0 0 120 120" aria-hidden="true">
                <defs>
                  <radialGradient id="pinGrad" cx="50%" cy="50%" r="50%">
                    <stop offset="0%" stop-color="#fff"/>
                    <stop offset="100%" stop-color="#ddd"/>
                  </radialGradient>
                </defs>
                <!-- Outer circle badge -->
                <circle cx="60" cy="60" r="34" fill="url(#pinGrad)" stroke="var(--bs-border-color)"/>
                <!-- Up arrow from center -->
                <path d="M60 18 L48 48 L72 48 Z" fill="var(--brand)"/>
                <!-- Dot -->
                <circle cx="60" cy="60" r="6" fill="var(--brand-2)"/>
              </svg>
            </div>

            <div class="d-grid gap-2">
              <button id="spinBtn" class="btn btn-success btn-lg" disabled>SPIN</button>
            </div>

            <div class="mt-4">
              <h6 class="mb-2">Legenda Warna</h6>
              <div id="legend" class="d-flex flex-wrap gap-3"></div>
            </div>

            <hr class="my-4" />

            <h5 class="mb-3">Pemenang</h5>
            <div class="table-responsive">
              <table class="table align-middle">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Peserta</th>
                    <th>Hadiah</th>
                  </tr>
                </thead>
                <tbody id="winnersBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="text-center text-body-secondary small my-4">By ChatGPT • Bootstrap 5 • Canvas API</footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // -----------------------------
    // Helpers
    // -----------------------------
    const $ = sel => document.querySelector(sel);
    const h = (tag, props = {}, ...kids) => {
      const el = document.createElement(tag);
      Object.entries(props).forEach(([k,v]) => {
        if (k === 'class') el.className = v; else if (k === 'style') Object.assign(el.style, v); else el.setAttribute(k, v);
      });
      kids.flat().forEach(k => el.append(k.nodeType ? k : document.createTextNode(k)));
      return el;
    };

    // Deterministic color based on text label (stable before/after spin)
    function colorFor(label){
      let hash = 0;
      for (let i=0; i<label.length; i++) hash = (hash*31 + label.charCodeAt(i)) >>> 0;
      const h = hash % 360;
      const s = 65; // saturation
      const l = 55; // lightness
      return `hsl(${h} ${s}% ${l}%)`;
    }

    // Parse textarea lines -> array of strings (non-empty)
    function parseLines(txt){
      return txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    }

    // Parse prizes: supports "Nama x N" or repeated lines
    function expandPrizes(lines){
      const items = [];
      lines.forEach(line=>{
        const m = line.match(/^(.*?)(?:\s*[xX]\s*(\d+))\s*$/);
        if (m){
          const name = m[1].trim();
          const n = Math.max(1, parseInt(m[2],10)||1);
          for (let i=0;i<n;i++) items.push(name);
        } else if (line){
          items.push(line);
        }
      });
      return items;
    }

    // -----------------------------
    // State
    // -----------------------------
    const state = {
      participants: [],   // queue
      prizesPool: [],     // array of prize names (expanded)
      winners: [],        // [{name, prize}]
      angle: 0,           // current wheel rotation (radians)
      spinning: false,
    };

    // -----------------------------
    // Canvas Draw
    // -----------------------------
    const wheel = $('#wheel');
    const ctx = wheel.getContext('2d');
    const R = wheel.width/2; // radius

    function drawWheel(){
      ctx.clearRect(0,0,wheel.width,wheel.height);
      const { prizesPool, angle } = state;
      const n = prizesPool.length;

      // Outer shadow ring
      ctx.save();
      ctx.translate(R, R);
      ctx.rotate(angle);

      if (n === 0){
        // Empty wheel
        ctx.beginPath();
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--bs-border-color').trim() || '#ddd';
        ctx.arc(0,0,R-6,0,Math.PI*2);
        ctx.fill();
        ctx.fillStyle = '#999';
        ctx.font = '700 40px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('Tidak ada hadiah',0,0);
        ctx.restore();
        return;
      }

      const slice = (Math.PI*2)/n;

      // Slices
      for (let i=0;i<n;i++){
        const start = i*slice;
        const end = start + slice;
        const label = prizesPool[i];
        const color = colorFor(label);

        // sector
        ctx.beginPath();
        ctx.moveTo(0,0);
        ctx.arc(0,0,R-10,start,end);
        ctx.closePath();
        ctx.fillStyle = color;
        ctx.fill();

        // border
        ctx.strokeStyle = 'rgba(0,0,0,0.12)';
        ctx.lineWidth = 2;
        ctx.stroke();

        // text
        ctx.save();
        ctx.fillStyle = '#fff';
        ctx.rotate(start + slice/2);
        ctx.textAlign = 'right';
        ctx.textBaseline = 'middle';
        ctx.font = '600 32px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
        ctx.shadowColor = 'rgba(0,0,0,.25)';
        ctx.shadowBlur = 4;
        ctx.shadowOffsetY = 2;
        ctx.fillText(label, R-30, 0);
        ctx.restore();
      }

      // center hub
      ctx.beginPath();
      ctx.fillStyle = '#fff';
      ctx.arc(0,0,50,0,Math.PI*2);
      ctx.fill();
      ctx.lineWidth = 4;
      ctx.strokeStyle = 'rgba(0,0,0,.1)';
      ctx.stroke();

      ctx.restore();

      // top notch ring
      ctx.save();
      ctx.translate(R,R);
      ctx.beginPath();
      ctx.lineWidth = 10;
      ctx.strokeStyle = 'rgba(0,0,0,.08)';
      ctx.arc(0,0,R-5,0,Math.PI*2);
      ctx.stroke();
      ctx.restore();
    }

    // -----------------------------
    // Spin Logic
    // -----------------------------
    function spin(){
      if (state.spinning) return;
      if (state.participants.length === 0){
        alert('Peserta sudah habis.');
        return;
      }
      if (state.prizesPool.length === 0){
        alert('Hadiah sudah habis.');
        return;
      }

      const player = state.participants.shift();
      updateCurrentPlayer();

      // pick a random index among current slices
      const n = state.prizesPool.length;
      const slice = (Math.PI*2)/n;
      const index = Math.floor(Math.random()*n);

      // angle where pointer (upwards, -90deg) meets center of selected slice
      const targetCenter = -Math.PI/2 - (index*slice + slice/2);
      const turns = 6 + Math.floor(Math.random()*4); // 6..9 full turns
      // compute final absolute angle (relative to 0)
      let finalAngle = targetCenter + turns*2*Math.PI;

      // animate from current angle to finalAngle smoothly
      const startAngle = state.angle;
      const delta = normalizeAngle(finalAngle - startAngle);
      const duration = 4200; // ms
      const t0 = performance.now();
      state.spinning = true;
      $('#spinBtn').disabled = true;

      function easeOutCubic(x){ return 1 - Math.pow(1 - x, 3); }

      function frame(t){
        const p = Math.min(1, (t - t0)/duration);
        const eased = easeOutCubic(p);
        state.angle = startAngle + delta*eased;
        drawWheel();
        if (p < 1){ requestAnimationFrame(frame); }
        else {
          // lock to exact target center to avoid text jitter
          state.angle = startAngle + delta;
          drawWheel();
          // resolve winner
          const prize = state.prizesPool[index];
          // remove that slice from pool
          state.prizesPool.splice(index,1);
          // record winner
          state.winners.push({ name: player, prize });
          renderWinners();
          updateRemaining();
          buildLegend();
          confettiBurst();
          // Sound pop via WebAudio
          playChime();
          // prepare next player
          updateCurrentPlayer();
          state.spinning = false;
          $('#spinBtn').disabled = (state.participants.length===0 || state.prizesPool.length===0);
        }
      }
      requestAnimationFrame(frame);
    }

    function normalizeAngle(a){
      // ensure positive around current orientation
      const tau = Math.PI*2;
      while (a < 0) a += tau;
      while (a > tau*1000) a -= tau; // guard
      return a;
    }

    // -----------------------------
    // Confetti (simple, lightweight)
    // -----------------------------
    const confettiCanvas = $('#confetti');
    const cctx = confettiCanvas.getContext('2d');
    function resizeConfetti(){ confettiCanvas.width = innerWidth; confettiCanvas.height = innerHeight; }
    window.addEventListener('resize', resizeConfetti); resizeConfetti();

    function confettiBurst(){
      const pieces = Array.from({length: 160}, (_,i)=>({
        x: innerWidth/2, y: innerHeight/4, // top-center-ish
        vx: (Math.random()*2-1)*6,
        vy: (Math.random()*-2-4),
        g: 0.15 + Math.random()*0.2,
        s: 6+Math.random()*6,
        a: Math.random()*Math.PI*2,
        va: (Math.random()*2-1)*0.2,
        col: `hsl(${Math.random()*360} 80% 55%)`
      }));
      const tStart = performance.now();
      const dur = 2200;

      function tick(t){
        const p = (t - tStart)/dur;
        cctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
        pieces.forEach(o=>{
          o.vy += o.g; o.x += o.vx; o.y += o.vy; o.a += o.va;
          cctx.save();
          cctx.translate(o.x, o.y);
          cctx.rotate(o.a);
          cctx.fillStyle = o.col;
          cctx.fillRect(-o.s/2, -o.s/2, o.s, o.s);
          cctx.restore();
        });
        if (p < 1) requestAnimationFrame(tick); else cctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
      }
      requestAnimationFrame(tick);
    }

    // Simple chime
    function playChime(){
      try {
        const ac = new (window.AudioContext || window.webkitAudioContext)();
        const o = ac.createOscillator();
        const g = ac.createGain();
        o.connect(g); g.connect(ac.destination);
        o.type = 'triangle';
        const now = ac.currentTime;
        o.frequency.setValueAtTime(880, now);
        o.frequency.exponentialRampToValueAtTime(440, now + 0.35);
        g.gain.setValueAtTime(0.0001, now);
        g.gain.exponentialRampToValueAtTime(0.4, now + 0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, now + 0.45);
        o.start(now); o.stop(now + 0.5);
      } catch(e) { /* ignore */ }
    }

    // -----------------------------
    // UI renderers
    // -----------------------------
    function renderWinners(){
      const tbody = $('#winnersBody');
      tbody.innerHTML = '';
      state.winners.forEach((w, i)=>{
        const tr = h('tr',{},
          h('td',{}, i+1),
          h('td',{}, w.name),
          h('td',{}, h('span',{class:'badge text-bg-primary winner-badge'}, w.prize))
        );
        tbody.appendChild(tr);
      });
    }

    function updateRemaining(){ $('#remainingPrizes').textContent = state.prizesPool.length; }
    function updateCurrentPlayer(){ $('#currentPlayer').textContent = state.participants[0] || '—'; }

    function buildLegend(){
      const legend = $('#legend');
      legend.innerHTML='';
      const uniq = [...new Set(state.prizesPool.concat(state.winners.map(w=>w.prize)))];
      uniq.forEach(name=>{
        legend.append(
          h('span',{}, h('span',{class:'legend-swatch', style:{background: colorFor(name)}}), name)
        );
      });
    }

    // -----------------------------
    // Apply data & Reset
    // -----------------------------
    function applyData(){
      const names = parseLines($('#participantsInput').value);
      const prizeLines = parseLines($('#prizesInput').value);
      const items = expandPrizes(prizeLines);

      // guard: each participant can only win once; we just keep queue order
      state.participants = names.slice(0);
      state.prizesPool = items.slice(0);
      state.winners = [];
      state.angle = 0;
      drawWheel();
      renderWinners();
      updateRemaining();
      updateCurrentPlayer();
      buildLegend();
      $('#spinBtn').disabled = (state.participants.length===0 || state.prizesPool.length===0);
    }

    function resetAll(){
      seedDefaults();
      applyData();
    }

    // -----------------------------
    // Theme toggle using data-bs-theme
    // -----------------------------
    function setTheme(mode){
      document.documentElement.setAttribute('data-bs-theme', mode);
      localStorage.setItem('theme', mode);
      $('.theme-label').textContent = mode === 'light' ? 'Dark' : 'Light';
    }

    function toggleTheme(){
      const cur = document.documentElement.getAttribute('data-bs-theme') || 'light';
      setTheme(cur === 'light' ? 'dark' : 'light');
    }

    // -----------------------------
    // Wiring
    // -----------------------------
    $('#applyBtn').addEventListener('click', applyData);
    $('#spinBtn').addEventListener('click', spin);
    $('#resetBtn').addEventListener('click', resetAll);
    $('#toggleTheme').addEventListener('click', toggleTheme);

    // -----------------------------
    // Defaults
    // -----------------------------
    function seedDefaults(){
      const defaultNames = [
        'Andi','Budi','Citra','Dini','Eko','Fajar','Gita','Hani','Indra','Joko'
      ].join('\n');
      const defaultPrizes = [
        'Motor x1',
        'Kulkas x1',
        'Rumah x2',
        'TV x5',
        'Lemari x1'
      ].join('\n');
      $('#participantsInput').value = defaultNames;
      $('#prizesInput').value = defaultPrizes;
    }

    // boot
    (function init(){
      // restore theme
      const saved = localStorage.getItem('theme');
      setTheme(saved || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light'));
      seedDefaults();
      applyData();
    })();
  </script>
</body>
</html>
